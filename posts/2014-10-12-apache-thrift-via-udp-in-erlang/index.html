<!DOCTYPE html>
<html lang="en">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.80.0" /><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Apache Thrift via UDP in Erlang | gruchalski.com</title>

    <link rel="stylesheet" href="/css/meme.min.c52d01779616c51cf9e5645a858d46e5aeb85f3cf186b96d11f0e45b87171345.css"/>

    
    
        <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js" defer></script><script src="/js/meme.min.23336c0ab28f7f46a1fd615235bffae1441553a19c58092119156cb729dbddb3.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" /></noscript>

    <meta name="author" content="radek gruchalski" /><meta name="description" content="A few months ago I have started learning Erlang, mostly for fun but it was right about time to jump on the functional bandwagon. The best way to learn a new language is to find an engaging project, in my case its been something what has been on my mind for quite a while: a cloud communication protocol / framework for distributed computing." />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="gruchalski.com" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="gruchalski.com" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    
        <link rel="canonical" href="https://gruchalski.com/posts/2014-10-12-apache-thrift-via-udp-in-erlang/" />
    

    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2014-10-12T00:00:00+00:00",
        "dateModified": "2020-09-03T02:03:37+02:00",
        "url": "https://gruchalski.com/posts/2014-10-12-apache-thrift-via-udp-in-erlang/",
        "headline": "Apache Thrift via UDP in Erlang",
        "description": "A few months ago I have started learning Erlang, mostly for fun but it was right about time to jump on the functional bandwagon. The best way to learn a new language is to find an engaging project, in my case its been something what has been on my mind for quite a while: a cloud communication protocol / framework for distributed computing.",
        "inLanguage" : "en",
        "articleSection": "posts",
        "wordCount":  2370 ,
        "image": "https://gruchalski.com/icons/apple-touch-icon.png",
        "author": {
            "@type": "Person",
            "email": "radek@gruchalski.com",
            "image": "https://gruchalski.com/icons/apple-touch-icon.png",
            "url": "https://io-oi.me/",
            "name": "radek gruchalski"
        },
        "license": "[reposting requires attribution, **use canonical links** Â»](https://en.wikipedia.org/wiki/Canonical_link_element)",
        "publisher": {
            "@type": "Organization",
            "name": "gruchalski.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://gruchalski.com/icons/apple-touch-icon.png"
            },
            "url": "https://gruchalski.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://gruchalski.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary" />


    



<meta property="og:title" content="Apache Thrift via UDP in Erlang" />
<meta property="og:description" content="A few months ago I have started learning Erlang, mostly for fun but it was right about time to jump on the functional bandwagon. The best way to learn a new language is to find an engaging project, in my case its been something what has been on my mind for quite a while: a cloud communication protocol / framework for distributed computing." />
<meta property="og:url" content="https://gruchalski.com/posts/2014-10-12-apache-thrift-via-udp-in-erlang/" />
<meta property="og:site_name" content="gruchalski.com" />
<meta property="og:locale" content="en" /><meta property="og:image" content="https://gruchalski.com/icons/apple-touch-icon.png" />
        <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2014-10-12T00:00:00&#43;00:00" />
    <meta property="article:modified_time" content="2020-09-03T02:03:37&#43;02:00" />
    
    <meta property="article:section" content="posts" />


        <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />

        




    
    <script>
        var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
        var doNotTrack = (dnt == "1" || dnt == "yes");
        if (!doNotTrack) {
            window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
            if (window.sessionStorage) {
                var GA_SESSION_STORAGE_KEY = 'ga:clientId';
                ga('create', 'UA-39073034-1', {
                'storage': 'none',
                'clientId': sessionStorage.getItem(GA_SESSION_STORAGE_KEY)
               });
               ga(function(tracker) {
                sessionStorage.setItem(GA_SESSION_STORAGE_KEY, tracker.get('clientId'));
               });
           }
            ga('set', 'anonymizeIp', true);
            ga('send', 'pageview');
        }
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    


    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">gruchalski.com</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">posts</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">tags</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">about</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/privacy/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" class="icon info"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"/></svg><span class="menu-item-name">privacy</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href=""></a>
                </li>
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="default" data-type="posts" data-layout="post" data-toc-num="true">

            <h1 class="post-title p-name">Apache Thrift via UDP in Erlang</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2014-10-12T00:00:00&#43;00:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;October 12, 2014</time>
    
    
    
    
        
        
        
            
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;2370</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;12&nbsp;mins</span>
    
    
    
</div>

            

            

            <div class="post-body e-content">
              <p>A few months ago I have started learning Erlang, mostly for fun but it was right about time to jump on the functional bandwagon. The best way to learn a new language is to find an engaging project, in my case its been something what has been on my mind for quite a while: a cloud communication protocol / framework for distributed computing. Some basic principles of what it is about can be found here: <a href="https://github.com/radekg/clouddds" target="_blank" rel="noopener">CloudDDS</a>.</p>
<p>While learning Erlang, I decided to also learn a number of other technologies, or using other words - apply them in practice. One of those is Apache Thrift. Apache Thrift is a binary cross-language framework for distributed service development. It is a serialization protocol with its own RPC stack.</p>
<p>Thrift RPC stack comes with a number of supported protocols, referred to as <code>transports</code>. Erlang implementation provides HTTP, JSON, file, disk log and framed transports. The project I was working on uses UDP for all communication. Below, I am going to describe how I implemented Thrift over UDP in Erlang. I will walk the reader through building a simple active-active setup of two clients communicating via UDP using Thrift messages.</p>
<h2 id="prerequisites"><a href="#prerequisites" class="anchor-link">Â§</a>Prerequisites</h2>
<p>Apache Thrift uses <code>.thrift</code> file to describe services and types  to used by the software. To generate the language code, Apache Thrift must be installed first. There is a lot of examples available how this can be achieved. I have created a bash script for Ubuntu 12.04 for my own reference, available here: <a href="https://gist.github.com/radekg/220b68b5b812c796efdd" target="_blank" rel="noopener">Install Thrift 0.9.1 with all language support</a>.</p>
<h2 id="design"><a href="#design" class="anchor-link">Â§</a>Design</h2>
<p>I will follow the standard OTP principles while developing the example.</p>
<pre><code>application -&gt; supervisor -&gt; UDP messaging worker
                        | -&gt; serialization worker
</code></pre>
<p>While discussing the implementation, I will not focus on the details of the messaging code, neither I will dive into the details of the standard OTP components. I will focus only on the Thrift part.</p>
<h2 id="basic-otp-modules"><a href="#basic-otp-modules" class="anchor-link">Â§</a>Basic OTP modules</h2>
<p>First step is to create a basic Erlang application. All the code can be found below. Additionally, at the bottom of the article I am publishing the link to the sources available on github.</p>
<h4 id="rebarconfig"><a href="#rebarconfig" class="anchor-link">Â§</a>rebar.config</h4>
<p>A bare minimum required for installing dependencies.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">{</span><span class="n">deps</span><span class="p">,</span> <span class="p">[</span>
  <span class="p">{</span><span class="n">thrift</span><span class="p">,</span> <span class="s">&#34;.*&#34;</span><span class="p">,</span>
    <span class="p">{</span><span class="n">git</span><span class="p">,</span> <span class="s">&#34;https://github.com/radekg/thrift-erlang.git&#34;</span><span class="p">,</span> <span class="s">&#34;master&#34;</span><span class="p">}}</span>
<span class="p">]}.</span>
</code></pre></td></tr></table></div>
</div>
</div><p>I am using my own fork of Thrift, it contains updated JSX dependencies.</p>
<h4 id="srcudp_thriftappsrc"><a href="#srcudp_thriftappsrc" class="anchor-link">Â§</a>src/udp_thrift.app.src</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">{</span><span class="n">application</span><span class="p">,</span> <span class="n">udp_thrift</span><span class="p">,</span>
  <span class="p">[{</span><span class="n">description</span><span class="p">,</span> <span class="s">&#34;Example of using Thrift with UDP&#34;</span><span class="p">},</span>
  <span class="p">{</span><span class="n">vsn</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">},</span>
  <span class="p">{</span><span class="n">modules</span><span class="p">,</span> <span class="p">[</span><span class="n">udp_thrift_types</span><span class="p">,</span>
             <span class="n">udp_thrift_app</span><span class="p">,</span>
             <span class="n">udp_thrift_common</span><span class="p">,</span>
             <span class="n">udp_thrift_sup</span><span class="p">,</span>
             <span class="n">udp_thrift_messaging</span><span class="p">,</span>
             <span class="n">udp_thrift_serialization</span><span class="p">]},</span>
  <span class="p">{</span><span class="n">registered</span><span class="p">,</span> <span class="n">udp_thrift_sup</span><span class="p">},</span>
  <span class="p">{</span><span class="n">applications</span><span class="p">,</span> <span class="p">[</span><span class="n">kernel</span><span class="p">,</span> <span class="n">stdlib</span><span class="p">,</span> <span class="n">crypto</span><span class="p">,</span> <span class="n">thrift</span><span class="p">]},</span>
  <span class="p">{</span><span class="n">mod</span><span class="p">,</span> <span class="p">{</span><span class="n">udp_thrift_app</span><span class="p">,</span> <span class="p">[]}}]}.</span>
</code></pre></td></tr></table></div>
</div>
</div><h4 id="srcudp_thrift_apperl"><a href="#srcudp_thrift_apperl" class="anchor-link">Â§</a>src/udp_thrift_app.erl</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">udp_thrift_app</span><span class="p">).</span>
<span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">application</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">start</span><span class="p">(_</span><span class="nv">Type</span><span class="p">,</span> <span class="p">_</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">udp_thrift_sup</span><span class="p">:</span><span class="nf">start_link</span><span class="p">().</span>
<span class="nf">stop</span><span class="p">(_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="n">ok</span><span class="p">.</span>
</code></pre></td></tr></table></div>
</div>
</div><h4 id="srcudp_thrift_commonerl"><a href="#srcudp_thrift_commonerl" class="anchor-link">Â§</a>src/udp_thrift_common.erl</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">udp_thrift_common</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span>
  <span class="n">get_timestamp</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">get_message_id_as_string</span><span class="o">/</span><span class="mi">0</span> <span class="p">]).</span>

<span class="nf">get_timestamp</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="nv">Mega</span><span class="p">,</span><span class="nv">Sec</span><span class="p">,</span><span class="nv">Micro</span><span class="p">}</span> <span class="o">=</span> <span class="nn">os</span><span class="p">:</span><span class="nf">timestamp</span><span class="p">(),</span>
  <span class="nb">trunc</span><span class="p">(</span> <span class="p">((</span><span class="nv">Mega</span><span class="o">*</span><span class="mi">1000000</span><span class="o">+</span><span class="nv">Sec</span><span class="p">)</span><span class="o">*</span><span class="mi">1000000</span><span class="o">+</span><span class="nv">Micro</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="p">).</span>

<span class="nf">get_message_id_as_string</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span> <span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span> <span class="s">&#34;</span><span class="si">~p</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span> <span class="n">make_ref</span><span class="p">()</span> <span class="p">]</span> <span class="p">)</span> <span class="p">).</span>
</code></pre></td></tr></table></div>
</div>
</div><h4 id="srcudp_thrift_superl"><a href="#srcudp_thrift_superl" class="anchor-link">Â§</a>src/udp_thrift_sup.erl</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">udp_thrift_sup</span><span class="p">).</span>
<span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">supervisor</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[]).</span>

<span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
  <span class="nv">Port</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="k">of</span>
    <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span> <span class="p">}</span> <span class="o">-&gt;</span>
      <span class="nv">Value</span><span class="p">;</span>
    <span class="n">undefined</span> <span class="o">-&gt;</span>
      <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="n">no_port</span> <span class="p">}</span>
  <span class="k">end</span><span class="p">,</span>
  <span class="nv">PeerPort</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">peer_port</span><span class="p">)</span> <span class="k">of</span>
    <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Value2</span> <span class="p">}</span> <span class="o">-&gt;</span>
      <span class="nv">Value2</span><span class="p">;</span>
    <span class="n">undefined</span> <span class="o">-&gt;</span>
      <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="n">no_peer_port</span> <span class="p">}</span>
  <span class="k">end</span><span class="p">,</span>
  <span class="k">case</span> <span class="nn">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">of</span>
    <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Name</span> <span class="p">}</span> <span class="o">-&gt;</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="n">one_for_all</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
          <span class="p">[</span>
            <span class="p">{</span>
              <span class="n">udp_thrift_messaging</span><span class="p">,</span>
              <span class="p">{</span><span class="n">udp_thrift_messaging</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span> <span class="p">{</span><span class="mi">127</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">]},</span>
              <span class="n">permanent</span><span class="p">,</span>
              <span class="n">brutal_kill</span><span class="p">,</span>
              <span class="n">worker</span><span class="p">,</span>
              <span class="p">[]</span>
            <span class="p">},</span> <span class="p">{</span>
              <span class="n">udp_thrift_serialization</span><span class="p">,</span>
              <span class="p">{</span><span class="n">udp_thrift_serialization</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[]},</span>
              <span class="n">permanent</span><span class="p">,</span>
              <span class="n">brutal_kill</span><span class="p">,</span>
              <span class="n">worker</span><span class="p">,</span>
              <span class="p">[]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="n">undefined</span> <span class="o">-&gt;</span>
      <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="n">no_name_given</span> <span class="p">}</span>
  <span class="k">end</span><span class="p">.</span>
</code></pre></td></tr></table></div>
</div>
</div><p>The supervisor expects a number of environment properties to be set. This will be provided later on, in <em>Running and testing</em> section. If one or more of these is not provided, the application will not start or fail at a worker start step.</p>
<h4 id="srcudp_thrift_messagingerl"><a href="#srcudp_thrift_messagingerl" class="anchor-link">Â§</a>src/udp_thrift_messaging.erl</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">udp_thrift_messaging</span><span class="p">).</span>
<span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&#34;udp_thrift_types.hrl&#34;</span><span class="p">).</span>

<span class="nf">start_link</span><span class="p">(</span><span class="nv">BindAddress</span><span class="p">,</span> <span class="nv">BindPort</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span>
                         <span class="p">[</span><span class="nv">BindAddress</span><span class="p">,</span> <span class="nv">BindPort</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span><span class="p">],</span> <span class="p">[]).</span>

<span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">stop</span><span class="p">).</span>

<span class="nf">init</span><span class="p">([</span><span class="nv">BindAddress</span><span class="p">,</span> <span class="nv">BindPort</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="k">case</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">BindPort</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">ip</span><span class="p">,</span> <span class="nv">BindAddress</span><span class="p">}])</span> <span class="k">of</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="nn">erlang</span><span class="p">:</span><span class="nb">send_after</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="p">{</span> <span class="n">contact_peer</span><span class="p">,</span> <span class="nv">BindPort</span> <span class="p">}),</span>
      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span><span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span><span class="p">}};</span>
    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span>
  <span class="k">end</span><span class="p">.</span>

<span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">{</span><span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="p">_})</span> <span class="o">-&gt;</span>
  <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>

<span class="nf">handle_cast</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">}.</span>

<span class="c">%% SENDING
</span><span class="c"></span>
<span class="nf">handle_info</span><span class="p">({</span> <span class="n">contact_peer</span><span class="p">,</span> <span class="nv">Port</span> <span class="p">},</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nn">error_logger</span><span class="p">:</span><span class="nf">info_msg</span><span class="p">(</span> <span class="s">&#34;Sending digest to </span><span class="si">~p</span><span class="s">.&#34;</span><span class="p">,</span> <span class="p">[</span> <span class="nv">PeerPort</span> <span class="p">]</span> <span class="p">),</span>
  <span class="nv">Digest</span> <span class="o">=</span> <span class="nl">#digest</span><span class="p">{</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nv">Name</span><span class="p">,</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nv">Port</span><span class="p">,</span>
    <span class="n">heartbeat</span> <span class="o">=</span> <span class="nn">udp_thrift_common</span><span class="p">:</span><span class="nf">get_timestamp</span><span class="p">(),</span>
    <span class="n">id</span> <span class="o">=</span> <span class="nn">udp_thrift_common</span><span class="p">:</span><span class="nf">get_message_id_as_string</span><span class="p">()</span> <span class="p">},</span>
  <span class="n">udp_thrift_serialization</span> <span class="o">!</span> <span class="p">{</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="nv">Digest</span><span class="p">,</span> <span class="n">self</span><span class="p">()</span> <span class="p">},</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">send_after</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="p">{</span> <span class="n">contact_peer</span><span class="p">,</span> <span class="nv">Port</span> <span class="p">}),</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}};</span>

<span class="nf">handle_info</span><span class="p">({</span> <span class="n">message_serialized</span><span class="p">,</span> <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">SerializedMessage</span> <span class="p">}</span> <span class="p">},</span>
             <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span>
    <span class="nv">Socket</span><span class="p">,</span>
    <span class="p">{</span> <span class="mi">127</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="p">},</span>
    <span class="nv">PeerPort</span><span class="p">,</span>
    <span class="nv">SerializedMessage</span> <span class="p">),</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}</span> <span class="p">};</span>

<span class="c">%% RECEIVING
</span><span class="c"></span>
<span class="nf">handle_info</span><span class="p">({</span><span class="n">udp</span><span class="p">,</span> <span class="p">_</span><span class="nv">ClientSocket</span><span class="p">,</span> <span class="p">_</span><span class="nv">ClientIp</span><span class="p">,</span> <span class="p">_</span><span class="nv">ClientPort</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span>
             <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="n">udp_thrift_serialization</span> <span class="o">!</span> <span class="p">{</span> <span class="n">deserialize</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">,</span> <span class="n">self</span><span class="p">()</span> <span class="p">},</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}};</span>

<span class="nf">handle_info</span><span class="p">({</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">DecodedPayloadType</span><span class="p">,</span> <span class="nv">DecodedPayload</span> <span class="p">}</span> <span class="p">},</span>
             <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="n">self</span><span class="p">()</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message</span><span class="p">,</span> <span class="nv">DecodedPayloadType</span><span class="p">,</span> <span class="nv">DecodedPayload</span> <span class="p">},</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}};</span>

<span class="nf">handle_info</span><span class="p">({</span> <span class="n">message</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="nv">DecodedPayload</span> <span class="p">},</span>
             <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nn">error_logger</span><span class="p">:</span><span class="nf">info_msg</span><span class="p">(</span><span class="s">&#34;Received digest from </span><span class="si">~p</span><span class="s">. Replying to </span><span class="si">~p</span><span class="s">&#34;</span><span class="p">,</span>
                         <span class="p">[</span> <span class="nv">DecodedPayload</span><span class="nl">#digest.name</span><span class="p">,</span> <span class="nv">DecodedPayload</span><span class="nl">#digest.port</span> <span class="p">]),</span>
  <span class="nv">DigestAck</span> <span class="o">=</span> <span class="nl">#digestAck</span><span class="p">{</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nv">Name</span><span class="p">,</span>
    <span class="n">heartbeat</span> <span class="o">=</span> <span class="nn">udp_thrift_common</span><span class="p">:</span><span class="nf">get_timestamp</span><span class="p">(),</span>
    <span class="n">reply_id</span> <span class="o">=</span> <span class="nv">DecodedPayload</span><span class="nl">#digest.id</span> <span class="p">},</span>
  <span class="n">udp_thrift_serialization</span> <span class="o">!</span> <span class="p">{</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">digestAck</span><span class="p">,</span> <span class="nv">DigestAck</span><span class="p">,</span> <span class="n">self</span><span class="p">()</span> <span class="p">},</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}};</span>

<span class="nf">handle_info</span><span class="p">({</span> <span class="n">message</span><span class="p">,</span> <span class="n">digestAck</span><span class="p">,</span> <span class="nv">DecodedPayload</span> <span class="p">},</span>
             <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nn">error_logger</span><span class="p">:</span><span class="nf">info_msg</span><span class="p">(</span><span class="s">&#34;Received digestAck to digest </span><span class="si">~p</span><span class="s">.&#34;</span><span class="p">,</span>
                         <span class="p">[</span> <span class="nv">DecodedPayload</span><span class="nl">#digestAck.reply_id</span> <span class="p">]),</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}};</span>

<span class="c">%% ERROR HANDLING
</span><span class="c"></span>
<span class="nf">handle_info</span><span class="p">({</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span> <span class="p">},</span>
             <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nn">error_logger</span><span class="p">:</span><span class="nf">error_msg</span><span class="p">(</span><span class="s">&#34;Message decode failed. Reason </span><span class="si">~p</span><span class="s">.&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Reason</span><span class="p">]),</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">messaging</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">PeerPort</span> <span class="p">}};</span>

<span class="nf">handle_info</span><span class="p">(</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">error_logger</span><span class="p">:</span><span class="nf">info_msg</span><span class="p">(</span><span class="s">&#34;Unhandled handle_info </span><span class="si">~p</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Msg</span><span class="p">]),</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">}.</span>

<span class="c">%% REMAINDER OF GEN_SERVER BEHAVIOUR
</span><span class="c"></span>
<span class="nf">handle_call</span><span class="p">({</span><span class="n">message</span><span class="p">,</span> <span class="p">_</span><span class="nv">Msg</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">}.</span>

<span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</code></pre></td></tr></table></div>
</div>
</div><h4 id="privateudp_thriftthrift"><a href="#privateudp_thriftthrift" class="anchor-link">Â§</a>private/udp_thrift.thrift</h4>
<p>The task of this example is for every client, at two seconds interval, send a <code>Digest</code> to the other client. On the other side of the wire, upon receiving the <code>Digest</code>, send a <code>DigestAck</code> message back. Every message is wrapped in a <code>DigestEnvelope</code> container so the program can easily establish what is the digest type sent. The <code>thrift</code> file looks like this:</p>
<pre><code>namespace erl udp_thrift

struct DigestEnvelope {
  1: required string payload_type;
  2: required string bin_payload;
}

struct Digest {
  1: required string name;
  2: required i32 port;
  3: required i64 heartbeat;
  4: required string id;
}

struct DigestAck {
  1: required string name;
  2: required i64 heartbeat;
  3: required string reply_id;
}
</code></pre><h2 id="generate-code-from-thrift-and-make-it-available"><a href="#generate-code-from-thrift-and-make-it-available" class="anchor-link">Â§</a>Generate code from Thrift and make it available</h2>
<p>Once thrift is installed on the system, the code can be generated from the <code>thrift</code> file. To do so:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> &lt;project root&gt;/private/
thrift --gen erl udp_thrift.thrift
mkdir -p ../include
<span class="c1"># make the generated code available for the program:</span>
mv gen-erl/udp_thrift_types.erl ../src/udp_thrift_types.erl
mv gen-erl/udp_thrift_constants.hrl ../include/udp_thrift_constants.hrl
mv gen-erl/udp_thrift_types.hrl ../include/udp_thrift_types.hrl
rm -Rf gen-erl
</code></pre></td></tr></table></div>
</div>
</div><p>The source code on github contains a Vagrant box which can be used to generate the code:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vagrant up thrift
</code></pre></td></tr></table></div>
</div>
</div><h2 id="thrift-serialisation-and-deserialisation"><a href="#thrift-serialisation-and-deserialisation" class="anchor-link">Â§</a>Thrift serialisation and deserialisation</h2>
<p>The module responsible for these tasks has been already started in the supervisor. Letâs go through the code and discuss the parts in detail.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">udp_thrift_serialization</span><span class="p">).</span>
<span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
          <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
          <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&#34;udp_thrift_types.hrl&#34;</span><span class="p">).</span>
</code></pre></td></tr></table></div>
</div>
</div><p>First, these records are required. As the serialisation happens within this single module, I include them directly by copying from Erlang Thrift sources.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">binary_protocol</span><span class="p">,</span> <span class="p">{</span><span class="n">transport</span><span class="p">,</span>
                          <span class="n">strict_read</span><span class="o">=</span><span class="n">true</span><span class="p">,</span>
                          <span class="n">strict_write</span><span class="o">=</span><span class="n">true</span>
                         <span class="p">}).</span>
<span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">memory_buffer</span><span class="p">,</span> <span class="p">{</span><span class="n">buffer</span><span class="p">}).</span>
</code></pre></td></tr></table></div>
</div>
</div><p>Following is the code for the module setup. For serialisation, a single protocol instance may be used for all serialized messages.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="nn">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>

<span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">OutThriftTransport</span><span class="p">}</span> <span class="o">=</span> <span class="nn">thrift_memory_buffer</span><span class="p">:</span><span class="nf">new</span><span class="p">(),</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">OutThriftProtocol</span><span class="p">}</span> <span class="o">=</span> <span class="nn">thrift_binary_protocol</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="nv">OutThriftTransport</span><span class="p">),</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span> <span class="n">serialization</span><span class="p">,</span> <span class="nv">OutThriftProtocol</span> <span class="p">}}.</span>

<span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">stop</span><span class="p">).</span>
</code></pre></td></tr></table></div>
</div>
</div><h4 id="serialization"><a href="#serialization" class="anchor-link">Â§</a>Serialization</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">handle_info</span><span class="p">({</span> <span class="n">serialize</span><span class="p">,</span> <span class="nv">DigestType</span><span class="p">,</span> <span class="nv">Digest</span><span class="p">,</span> <span class="nv">CallerPid</span> <span class="p">},</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="n">self</span><span class="p">()</span> <span class="o">!</span> <span class="p">{</span> <span class="n">serialize</span><span class="p">,</span> <span class="nv">DigestType</span><span class="p">,</span>
              <span class="nv">Digest</span><span class="p">,</span> <span class="nn">udp_thrift_types</span><span class="p">:</span><span class="nf">struct_info</span><span class="p">(</span><span class="nv">DigestType</span><span class="p">),</span>
              <span class="nv">CallerPid</span> <span class="p">},</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">};</span>

<span class="nf">handle_info</span><span class="p">({</span> <span class="n">serialize</span><span class="p">,</span> <span class="nv">DigestType</span><span class="p">,</span> <span class="nv">Digest</span><span class="p">,</span> <span class="nv">StructInfo</span><span class="p">,</span> <span class="nv">CallerPid</span> <span class="p">},</span>
             <span class="p">{</span> <span class="n">serialization</span><span class="p">,</span> <span class="nv">OutThriftProtocol</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nv">CallerPid</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message_serialized</span><span class="p">,</span>
                 <span class="p">{</span> <span class="n">ok</span><span class="p">,</span>
                    <span class="n">digest_to_binary</span><span class="p">(</span> <span class="nl">#digestEnvelope</span><span class="p">{</span>
                        <span class="n">payload_type</span> <span class="o">=</span> <span class="nb">atom_to_list</span><span class="p">(</span><span class="nv">DigestType</span><span class="p">),</span>
                        <span class="n">bin_payload</span> <span class="o">=</span> <span class="n">digest_to_binary</span><span class="p">(</span><span class="nv">Digest</span><span class="p">,</span> <span class="nv">StructInfo</span><span class="p">,</span> <span class="nv">OutThriftProtocol</span><span class="p">)</span>
                      <span class="p">},</span>
                      <span class="nn">udp_thrift_types</span><span class="p">:</span><span class="nf">struct_info</span><span class="p">(</span><span class="n">digestEnvelope</span><span class="p">),</span>
                      <span class="nv">OutThriftProtocol</span> <span class="p">)</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="p">{</span> <span class="n">serialization</span><span class="p">,</span> <span class="nv">OutThriftProtocol</span> <span class="p">}</span> <span class="p">};</span>
</code></pre></td></tr></table></div>
</div>
</div><p>First <code>handle_info</code> receives the data to serialize, it uses <code>udp_thrift_types:struct_info</code> provided by the thrift generated modules to get the <code>thrift</code> type definition. This is forwarded to the the second <code>handle_info</code>. <code>digest_to_binary</code> is where all the action happens (presented shortly). The inner <code>digest_to_binary</code> call serializes the digest received from <code>messaging</code> component. This is then wrapped inside of the <code>digestEnvelope</code> digest which has to be converted to binary data for UDP delivery.</p>
<h4 id="deserialization"><a href="#deserialization" class="anchor-link">Â§</a>Deserialization</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">handle_info</span><span class="p">({</span> <span class="n">deserialize</span><span class="p">,</span> <span class="nv">BinaryDigest</span><span class="p">,</span> <span class="nv">CallerPid</span> <span class="p">},</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">try</span>
    <span class="k">case</span> <span class="n">digest_from_binary</span><span class="p">(</span><span class="n">digestEnvelope</span><span class="p">,</span> <span class="nv">BinaryDigest</span><span class="p">)</span> <span class="k">of</span>
      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">DecodedResult</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="k">case</span> <span class="n">payload_type_as_known_atom</span><span class="p">(</span><span class="nv">DecodedResult</span><span class="nl">#digestEnvelope.payload_type</span><span class="p">)</span> <span class="k">of</span>
          <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">PayloadTypeAtom</span> <span class="p">}</span> <span class="o">-&gt;</span>
            <span class="k">case</span> <span class="n">digest_from_binary</span><span class="p">(</span>
                  <span class="nv">PayloadTypeAtom</span><span class="p">,</span>
                  <span class="nv">DecodedResult</span><span class="nl">#digestEnvelope.bin_payload</span><span class="p">)</span> <span class="k">of</span>
              <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">DecodedResult2</span> <span class="p">}</span> <span class="o">-&gt;</span>
                <span class="nv">CallerPid</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">PayloadTypeAtom</span><span class="p">,</span> <span class="nv">DecodedResult2</span> <span class="p">}</span> <span class="p">};</span>
              <span class="p">_</span> <span class="o">-&gt;</span>
                <span class="nn">error_logger</span><span class="p">:</span><span class="nf">error_msg</span><span class="p">(</span><span class="s">&#34;Message could not be decoded.&#34;</span><span class="p">),</span>
                <span class="nv">CallerPid</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="n">decode_binary_content_failed</span> <span class="p">}</span> <span class="p">}</span>
            <span class="k">end</span><span class="p">;</span>
          <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="nv">UnsupportedPayloadType</span> <span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nn">error_logger</span><span class="p">:</span><span class="nf">error_msg</span><span class="p">(</span><span class="s">&#34;Unsupprted message </span><span class="si">~p</span><span class="s">.&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">UnsupportedPayloadType</span><span class="p">]),</span>
            <span class="nv">CallerPid</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">unsuppoted_payload_type</span><span class="p">}</span> <span class="p">}</span>
        <span class="k">end</span><span class="p">;</span>
      <span class="p">_</span> <span class="o">-&gt;</span>
        <span class="nn">error_logger</span><span class="p">:</span><span class="nf">error_msg</span><span class="p">(</span><span class="s">&#34;Could not open digestEnvelope.&#34;</span><span class="p">),</span>
        <span class="nv">CallerPid</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">digest_envelope_open_failed</span><span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">catch</span>
    <span class="p">_</span><span class="nv">Error</span><span class="p">:</span><span class="nv">Reason</span> <span class="o">-&gt;</span>
      <span class="nn">gossiper_log</span><span class="p">:</span><span class="nf">err</span><span class="p">(</span><span class="s">&#34;Error while reading digest: </span><span class="si">~p</span><span class="s">.&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Reason</span><span class="p">]),</span>
      <span class="nv">CallerPid</span> <span class="o">!</span> <span class="p">{</span> <span class="n">message_deserialized</span><span class="p">,</span> <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="n">digest_read</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span><span class="p">,</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">};</span>

<span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">}.</span>
</code></pre></td></tr></table></div>
</div>
</div><p>Upon received a deserialization request, the first thing that happens is <code>deserialize_from_binary</code>. This function assumes that the data received is Thrift and the data is of type <code>digestEnvelope</code>. The details will be presented shortly. Once the payload carried by the envelope has been read, the program detects if the payload is of a supported type. If so, it attempts deserializing the content. If all of the above succeeds, the result is passed back to messaging (caller of the serialization). Majority of that function is simple error handling.</p>
<h4 id="digest_to_binary-digest_from_binary-and-payload_type_as_known_atom"><a href="#digest_to_binary-digest_from_binary-and-payload_type_as_known_atom" class="anchor-link">Â§</a>digest_to_binary, digest_from_binary and payload_type_as_known_atom</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">  <span class="n">digest_to_binary</span><span class="p">(</span><span class="nv">Digest</span><span class="p">,</span> <span class="nv">StructInfo</span><span class="p">,</span> <span class="nv">OutThriftProtocol</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">PacketThrift</span><span class="p">,</span> <span class="n">ok</span><span class="p">}</span> <span class="o">=</span> <span class="nn">thrift_protocol</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">OutThriftProtocol</span><span class="p">,</span>
                                               <span class="p">{</span> <span class="p">{</span><span class="n">struct</span><span class="p">,</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">StructInfo</span><span class="p">)},</span> <span class="nv">Digest</span><span class="p">}),</span>
    <span class="p">{</span><span class="n">protocol</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">OutProtocol</span><span class="p">}</span> <span class="o">=</span> <span class="nv">PacketThrift</span><span class="p">,</span>
    <span class="p">{</span><span class="n">transport</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">OutTransport</span><span class="p">}</span> <span class="o">=</span> <span class="nv">OutProtocol</span><span class="nl">#binary_protocol.transport</span><span class="p">,</span>
    <span class="nb">iolist_to_binary</span><span class="p">(</span><span class="nv">OutTransport</span><span class="nl">#memory_buffer.buffer</span><span class="p">).</span>
</code></pre></td></tr></table></div>
</div>
</div><p><code>digest_to_binary</code> serializes the payload. It uses the copy of the protocol defined in <code>init</code> to write the thrift binary representation of data to be sent. All what has to be done afterwards is converting <code>iolist</code> contained in the resulting <code>OutTransport</code> to <code>binary</code> data. This is returned to <code>CallerPid</code> and sent via UDP to the destination.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">digest_from_binary</span><span class="p">(</span><span class="nv">DigestType</span><span class="p">,</span> <span class="nv">BinaryDigest</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">InTransport</span><span class="p">}</span> <span class="o">=</span> <span class="nn">thrift_memory_buffer</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="nv">BinaryDigest</span><span class="p">),</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">InProtocol</span><span class="p">}</span> <span class="o">=</span> <span class="nn">thrift_binary_protocol</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="nv">InTransport</span><span class="p">),</span>
  <span class="k">case</span> <span class="nn">thrift_protocol</span><span class="p">:</span><span class="nf">read</span><span class="p">(</span>
         <span class="nv">InProtocol</span><span class="p">,</span>
         <span class="p">{</span><span class="n">struct</span><span class="p">,</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nn">udp_thrift_types</span><span class="p">:</span><span class="nf">struct_info</span><span class="p">(</span><span class="nv">DigestType</span><span class="p">))},</span>
         <span class="nv">DigestType</span><span class="p">)</span> <span class="k">of</span>
    <span class="p">{_,</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">DecodedResult</span><span class="p">}}</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">DecodedResult</span><span class="p">};</span>
    <span class="p">_</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">not_thrift</span><span class="p">}</span>
  <span class="k">end</span><span class="p">.</span>
</code></pre></td></tr></table></div>
</div>
</div><p><code>digest_from_binary</code> receives an <code>atom</code> of an expected digest type and a binary digest as an input. First, a <code>memory_buffer</code> transport is constructed from the binary data. It is then converted into a binary protocol and an attempt to read the data from <code>thrift</code> is made using a structure provided by <code>udp_thrift_types:struct_info</code>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">payload_type_as_known_atom</span><span class="p">(</span><span class="nv">DigestTypeBin</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nv">KnownDigestTypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="o">&lt;&lt;</span><span class="s">&#34;digest&#34;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">digest</span> <span class="p">},</span>
    <span class="p">{</span> <span class="o">&lt;&lt;</span><span class="s">&#34;digestAck&#34;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">digestAck</span> <span class="p">}</span> <span class="p">],</span>
  <span class="k">case</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">keyfind</span><span class="p">(</span> <span class="nv">DigestTypeBin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">KnownDigestTypes</span> <span class="p">)</span> <span class="k">of</span>
    <span class="n">false</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">error</span><span class="p">,</span> <span class="nv">DigestTypeBin</span> <span class="p">};</span>
    <span class="p">{</span> <span class="p">_</span><span class="nv">Bin</span><span class="p">,</span> <span class="nv">Atom</span> <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Atom</span> <span class="p">}</span>
  <span class="k">end</span><span class="p">.</span>
</code></pre></td></tr></table></div>
</div>
</div><p>The above function is rather self explanatory. The deserialization will be attempted if an <code>atom</code> can be found in the <code>KnownDigestTypes</code> for given digest type. Otherwise an error is returned.</p>
<p>The module ends with the rest of required <code>gen_server</code> behaviour.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Msg</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">}.</span>

<span class="nf">handle_cast</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">LoopData</span><span class="p">}.</span>

<span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">LoopData</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">}.</span>
  
<span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</code></pre></td></tr></table></div>
</div>
</div><h2 id="running-and-testing"><a href="#running-and-testing" class="anchor-link">Â§</a>Running and testing</h2>
<p>Preparation:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> &lt;project directory&gt;
./rebar get-deps
./rebar compile
</code></pre></td></tr></table></div>
</div>
</div><p>To run, two terminal windows are required. In the first window, start Erlang with this command:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">erl -pa ebin/ -pa deps/*/ebin
</code></pre></td></tr></table></div>
</div>
</div><p>Run the application:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&#34;memberA&#34;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">6666</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">peer_port</span><span class="p">,</span> <span class="mi">6667</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">crypto</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">thrift</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">).</span>
</code></pre></td></tr></table></div>
</div>
</div><p>In the second terminal window, start Erlang:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">erl -pa ebin/ -pa deps/*/ebin
</code></pre></td></tr></table></div>
</div>
</div><p>Run the application:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&#34;memberB&#34;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">6667</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">,</span> <span class="n">peer_port</span><span class="p">,</span> <span class="mi">6666</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">crypto</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">thrift</span><span class="p">).</span>
<span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">udp_thrift</span><span class="p">).</span>
</code></pre></td></tr></table></div>
</div>
</div><p>Both windows should be showing output similar to this:</p>
<pre><code>â¦
Sending digest to 6667.
=INFO REPORT==== 12-Oct-2014::21:43:43 ===
Sending digest to 6667.
=INFO REPORT==== 12-Oct-2014::21:43:43 ===
Received digestAck to digest &lt;&lt;&quot;#Ref&lt;0.0.0.95&gt;&quot;&gt;&gt;.
=INFO REPORT==== 12-Oct-2014::21:43:45 ===
Received digest from &lt;&lt;&quot;memberB&quot;&gt;&gt;. Replying to 6667
=INFO REPORT==== 12-Oct-2014::21:43:45 ===
Sending digest to 6667.
=INFO REPORT==== 12-Oct-2014::21:43:45 ===
Received digestAck to digest &lt;&lt;&quot;#Ref&lt;0.0.0.100&gt;&quot;&gt;&gt;.
=INFO REPORT==== 12-Oct-2014::21:43:47 ===
Received digest from &lt;&lt;&quot;memberB&quot;&gt;&gt;. Replying to 6667
=INFO REPORT==== 12-Oct-2014::21:43:47 ===
Sending digest to 6667.
=INFO REPORT==== 12-Oct-2014::21:43:47 ===
Received digestAck to digest &lt;&lt;&quot;#Ref&lt;0.0.0.105&gt;&quot;&gt;&gt;.
â¦
</code></pre><p>If that is the case, both clients are communicating via UDP with Thrift protocol.</p>
<h2 id="code-and-license"><a href="#code-and-license" class="anchor-link">Â§</a>Code and license</h2>
<p>All code discussed above can be found on github: <a href="https://github.com/radekg/apache-thrift-udp-erlang" target="_blank" rel="noopener">Using Apache Thrift with UDP in Erlang</a>. The code is available under <a href="https://github.com/radekg/apache-thrift-udp-erlang/blob/master/LICENSE" target="_blank" rel="noopener">MIT license</a>.</p>

            </div>

            <div class="subscribe-container">

    <h2 class="subscribe">Never miss a post</h2>
    <p class="subscribe">Interested in similar content? Get it right into your mailbox. <strong>Sign up now.</strong></p>

    <div class="inner">
        <form action="https://gruchalski.us1.list-manage.com/subscribe/post?u=7cc31051b7ae9b4636244cbb2&amp;id=80eb233246"
            method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate>
            
            <div class="away" aria-hidden="true"><input type="text" name="b_7cc31051b7ae9b4636244cbb2_80eb233246" tabindex="-1" value=""></div>
            <div class="form-fields">
                <input type="email" value="" name="EMAIL" placeholder="email address" />
                <input type="submit" value="Subscribe" name="subscribe" />
            </div>
        </form>
    </div>

</div>
            
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">Author</span>: <a href="https://io-oi.me/" class="p-author h-card" target="_blank" rel="noopener">radek gruchalski</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">Link</span>: <a href="/posts/2014-10-12-apache-thrift-via-udp-in-erlang/" target="_blank" rel="noopener">https://gruchalski.com/posts/2014-10-12-apache-thrift-via-udp-in-erlang/</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">License</span>: <a href="https://en.wikipedia.org/wiki/Canonical_link_element" target="_blank" rel="noopener">reposting requires attribution, <strong>use canonical links</strong> Â»</a></li>
            
        </ul>
    



        </article>

        

        


        


        <div class="post-share">

        

        <div class="share-items">

            
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=https://gruchalski.com/posts/2014-10-12-apache-thrift-via-udp-in-erlang/&amp;text=Apache%20Thrift%20via%20UDP%20in%20Erlang&amp;hashtags=thrift,erlang,&amp;via=%25!s%28%3cnil%3e%29" title="Share on Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            

            
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://gruchalski.com/posts/2014-10-12-apache-thrift-via-udp-in-erlang/&amp;title=Apache%20Thrift%20via%20UDP%20in%20Erlang&amp;summary=A%20few%20months%20ago%20I%20have%20started%20learning%20Erlang,%20mostly%20for%20fun%20but%20it%20was%20right%20about%20time%20to%20jump%20on%20the%20functional%20bandwagon.%20The%20best%20way%20to%20learn%20a%20new%20language%20is%20to%20find%20an%20engaging%20project,%20in%20my%20case%20its%20been%20something%20what%20has%20been%20on%20my%20mind%20for%20quite%20a%20while:%20a%20cloud%20communication%20protocol%20/%20framework%20for%20distributed%20computing.&amp;source=gruchalski.com" title="Share on LinkedIn" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            

            

            

            

            

            
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="Share via QR Code"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/gruchalski.com\/posts\/2014-10-12-apache-thrift-via-udp-in-erlang\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">See Also:<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/2014-12-09-gossiperl-gossip-middleware-in-erlang/" class="related-link">Gossiperl   gossip middleware in Erlang</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2015-01-05-state-of-gossiperl-and-some-javascript-thrift-goodies/" class="related-link">State of gossiperl and some JavaScript Thrift goodies</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2014-10-21-erflux-influxdb-client-for-erlang/" class="related-link">Erflux, InfluxDB client for Erlang</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/thrift/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>thrift</a>
                
            
                
                
                
                
                    
                    <a href="/tags/erlang/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>erlang</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/posts/2014-12-09-gossiperl-gossip-middleware-in-erlang/" rel="prev">&lt; Gossiperl   gossip middleware in Erlang</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/posts/2014-05-20-openstack-devstack-up-and-running-with-vagrant-in-125-minutes/" rel="next">OpenStack Devstack up and running with Vagrant, in 12.5 minutes &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">Â©&nbsp;2015â2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;radek gruchalski</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://en.wikipedia.org/wiki/Canonical_link_element" target="_blank" rel="noopener">reposting requires attribution, <strong>use canonical links</strong> Â»</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:radek@gruchalski.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/radekg" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://linkedin.com/in/radgruchalski" target="_blank" rel="external noopener" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon social-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </li></ul>
    



            <p>this website uses Google Analytics but<br />
    it respects your DNT settings, stores tracking ID in session storage instead of cookies and anonymizes IP addresses </p>
        </div>
    </footer>


        </div>
        

        








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
