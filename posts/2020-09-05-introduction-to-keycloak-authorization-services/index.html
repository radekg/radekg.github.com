<!DOCTYPE html>
<html lang="en">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.148.2"><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Introduction to Keycloak Authorization Services | gruchalski.com</title>

    <link rel="stylesheet" href="/css/meme.min.fe3b4eabe26125d7716d7271d1dcc928f862e422b39cc80a8c45354f89084434.css"/>

    
    
        <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js" defer></script><script src="/js/meme.min.1321582b41a9fdb1a15023a3d3204fa013ace575e4c594c9dbc43078a016fce0.js"></script>

    

    <link rel="stylesheet" href="/assets/fonts/amaranth.css?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="/assets/fonts/amaranth.css?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" /></noscript>

    <meta name="author" content="Radek Gruchalski" /><meta name="description" content="Investigating Keycloak Authorization Services using a real-world back office application scenario" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="gruchalski.com" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="gruchalski.com" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    
        <link rel="canonical" href="https://gruchalski.com/posts/2020-09-05-introduction-to-keycloak-authorization-services/" />
    

    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2020-09-05T00:00:00+00:00",
        "dateModified": "2023-07-04T23:40:31+02:00",
        "url": "https://gruchalski.com/posts/2020-09-05-introduction-to-keycloak-authorization-services/",
        "headline": "Introduction to Keycloak Authorization Services",
        "description": "Investigating Keycloak Authorization Services using a real-world back office application scenario",
        "inLanguage" : "en",
        "articleSection": "posts",
        "wordCount":  3308 ,
        "image": ["https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/create-realm.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/realm-roles.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/policies.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/authorization-scopes.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/delete-default-resource.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/resources.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/permissions.png","https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/user-password.png"],
        "author": {
            "@type": "Person",
            "url": "https://gruchalski.com/",
            
        },
        "license": "[reposting requires attribution, **use canonical links** »](https://en.wikipedia.org/wiki/Canonical_link_element)",
        "publisher": {
            "@type": "Organization",
            "name": "gruchalski.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://gruchalski.com/icons/apple-touch-icon.png"
            },
            "url": "https://gruchalski.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://gruchalski.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />



    



<meta property="og:title" content="Introduction to Keycloak Authorization Services" />
<meta property="og:description" content="Investigating Keycloak Authorization Services using a real-world back office application scenario" />
<meta property="og:url" content="https://gruchalski.com/posts/2020-09-05-introduction-to-keycloak-authorization-services/" />
<meta property="og:site_name" content="gruchalski.com" />
<meta property="og:locale" content="en" /><meta property="og:image" content="https://gruchalski.com/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/create-realm.png" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-09-05T00:00:00&#43;00:00" />
    <meta property="article:modified_time" content="2023-07-04T23:40:31&#43;02:00" />
    
    <meta property="article:section" content="posts" />



    
    

    
    <script async 
        src="https://analytics.svcs.sh/script.js"
        data-website-id="791140b3-1642-400d-82b9-6adcd1095688"
        data-do-not-track="true"
        data-domains="gruchalski.com"></script>

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">gruchalski.com</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">posts</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="icon code-branch"><path d="M384 144c0-44.2-35.8-80-80-80s-80 35.8-80 80c0 36.4 24.3 67.1 57.5 76.8-.6 16.1-4.2 28.5-11 36.9-15.4 19.2-49.3 22.4-85.2 25.7-28.2 2.6-57.4 5.4-81.3 16.9v-144c32.5-10.2 56-40.5 56-76.3 0-44.2-35.8-80-80-80S0 35.8 0 80c0 35.8 23.5 66.1 56 76.3v199.3C23.5 365.9 0 396.2 0 432c0 44.2 35.8 80 80 80s80-35.8 80-80c0-34-21.2-63.1-51.2-74.6 3.1-5.2 7.8-9.8 14.9-13.4 16.2-8.2 40.4-10.4 66.1-12.8 42.2-3.9 90-8.4 118.2-43.4 14-17.4 21.1-39.8 21.6-67.9 31.6-10.8 54.4-40.7 54.4-75.9zM80 64c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm0 384c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16zm224-320c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16z"/></svg><span class="menu-item-name">categories</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">tags</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">about</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/privacy/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" class="icon info"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"/></svg><span class="menu-item-name">privacy</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href=""></a>
                </li>
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="default" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">Introduction to Keycloak Authorization Services</h1>

            

            
                <div class="post-description p-summary">Investigating Keycloak Authorization Services using a real-world back office application scenario</div>
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2020-09-05T00:00:00&#43;00:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;September 5, 2020</time>
    
    
    
    
        
        
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;3308</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;16&nbsp;mins</span>
    
    
    
</div>

            

            

            <div class="post-body e-content">
              <p>As the number of applications and websites in the organization grows, the developer will inevitably receive a request to implement Single Sign-On. Single Sign-On (SSO for short) is an authentication scheme allowing the user to log in with a single set of credentials and share the session across multiple, independent, potentially unrelated systems.</p>
<p>The savvy developer will roll out Keycloak, enable Standard Flow client, maybe enable some of the social login options, like GitHub, Google or Facebook and call it a day. The users will be happy. When they go to any of the internet properties requiring signing in, if they are not signed in, they will be redirected to Keycloak login page. Once they log in, they receive a token, with which they can use to access any other property requiring login.</p>
<p>As a bonus, the SSO usually introduces a Single Log-Out (SLO). By invalidating the access token, the user is logged out of all the properties relying on that token.</p>
<div>
    <h2>table of contents</h2>
    <nav id="TableOfContents">
  <ol>
    <li><a href="#setting-up-the-scene">setting up the scene</a></li>
    <li><a href="#the-goal">the goal</a></li>
    <li><a href="#add-a-realm">add a realm</a></li>
    <li><a href="#configure-roles">configure roles</a></li>
    <li><a href="#the-openid-client">the OpenID Client</a>
      <ol>
        <li><a href="#settings-tab">settings tab</a></li>
        <li><a href="#scope-tab">scope tab</a></li>
        <li><a href="#authorization-tab">authorization tab</a>
          <ol>
            <li><a href="#authorization--settings">authorization / settings</a></li>
            <li><a href="#authorization--policies">authorization / policies</a></li>
            <li><a href="#authorization--authorization-scopes">authorization / authorization scopes</a></li>
            <li><a href="#authorization--resources">authorization / resources</a></li>
            <li><a href="#authorization--permissions">authorization / permissions</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#create-a-user">create a user</a>
      <ol>
        <li><a href="#user-credentials">user credentials</a></li>
      </ol>
    </li>
    <li><a href="#fetch-the-openid-client-credentials">fetch the OpenID Client credentials</a></li>
    <li><a href="#play-time">play time!</a>
      <ol>
        <li><a href="#uma-tickets">UMA tickets</a></li>
      </ol>
    </li>
    <li><a href="#top-secret-customer">top secret customer</a>
      <ol>
        <li><a href="#listing-available-customers">listing available customers</a></li>
      </ol>
    </li>
    <li><a href="#conclusion">conclusion</a></li>
    <li><a href="#further-reading">further reading</a></li>
  </ol>
</nav>
</div>
<h2 id="setting-up-the-scene"><a href="#setting-up-the-scene" class="anchor-link">§</a>setting up the scene</h2>
<p>But what if the complexity of the system goes one step further? For example, the user of the properties is a Member of the Support Team and the property in question is a support system where, for example, the Support Team member can view and manage some data on behalf of a Customer. The company has many Customers and many Support Team Members. Maybe some of the Support Team Members are dedicated to certain Customers? When they sign in to the Support System, they should only see and be able to act, on behalf of only those selected, dedicated Customers.</p>
<p>The first thought of any seasoned developer would most likely be to create a new database and store a mapping between the Support Team Member user and the Customer. The Support Application would then query the new database and only display the Customers for which the mappings exist. And that&rsquo;s fine, there is nothing wrong with approach. However, that&rsquo;s another database to maintain. Someone has to create the rules of which Member supports which Customer. This knowledge has to be stored somewhere and someone has to build an application to ensure the data in the new database is always up to date and relevant.</p>
<p>An alternative approach would be to use Keycloak for storing, managing and retrieval of all of this knowledge. If we consider Keycloak to be a single source of truth across the organization, we remove quite a lot of complexity.</p>
<p>So, further in this article, I am showing a proof of concept of Keycloak as a mechanism to allow Support Team Members to access selected Customers only, without any other database. This will also present how to use Keycloak Authorization Services in real-world scenario and give the reader a glimpse into User Managed Access (UMA).</p>
<p><a href="https://gruchalski.com/posts/2020-09-03-keycloak-with-docker-compose/" target="_blank" rel="noopener">I have described how to start a local development version of Keycloak</a>. Examples here will build on top of the previous write up. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">[1]</a></sup></p>
<h2 id="the-goal"><a href="#the-goal" class="anchor-link">§</a>the goal</h2>
<p>The outcome of this article is to have a Keycloak realm with an OpenID client configured so that a program can be created to query Keycloak for users&rsquo; entitlements and discover all available entitlements of a given type by leveraging Keycloak token and resource set endpoints.</p>
<p>We will configure a realm with required roles and set up Authorization Services resources, policies, scopes and permissions for two different access levels: a regular user, Service Team Member, and a supervisor, the user who is entitled to see all available resources, regardless of the role membership.</p>
<p>Without any further due, let&rsquo;s start!</p>
<h2 id="add-a-realm"><a href="#add-a-realm" class="anchor-link">§</a>add a realm</h2>
<p>Open the browser, go to <a href="http://localhost:28080/auth/admin/master/console/" target="_blank" rel="noopener">http://localhost:28080/auth/admin/master/console/</a>, sign in as <code>admin:admin</code>.</p>
<p>By default, we are signed in to the <code>Master</code> realm. So the first thing to do, is to create a new realm. In the top left corner, under the Keycloak logo, hover over <code>Master</code> or <code>Select realm</code> text. A menu will appear, there is the <code>Add realm</code> button. Click the button and on the form that shows up, type <code>multi-customer</code> in the <code>Name</code> field.</p>
<p>The realm is our disposable proving ground. All the users, roles and everything we will do further, resides inside. Deleting a realm, deletes all users and settings.</p>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/create-realm.png" alt="adding new realm"></p>
<h2 id="configure-roles"><a href="#configure-roles" class="anchor-link">§</a>configure roles</h2>
<p>We will represent our imaginary Customers as roles. We have to add a role for every Customer. In the left menu, find and click <code>Roles</code>. Create a role for every customer, for the sake of this article, I&rsquo;ll go with:</p>
<ul>
<li><code>CustomerA</code></li>
<li><code>CustomerB</code></li>
</ul>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/realm-roles.png" alt="adding realm roles"></p>
<h2 id="the-openid-client"><a href="#the-openid-client" class="anchor-link">§</a>the OpenID Client</h2>
<p>Now, we have to create an OpenID Client. Client is what allows the users of our application securely exchanging <code>client id</code> and <code>secret</code> for an <code>access token</code>. Click <code>Clients</code> in the left menu. On the page that opens, find the <code>Create</code> button near the top of the right corner of the page, click it.</p>
<p>Type <code>customers</code> as a <code>Client ID</code>. Leave <code>Client Protocol</code> as <code>openid-connect</code> and put <code>http://localhost:28080</code> as Root URL. Click <code>Save</code>. The page will reload and a bunch of other settings will become available.</p>
<h3 id="settings-tab"><a href="#settings-tab" class="anchor-link">§</a>settings tab</h3>
<p>Set them as follows:</p>
<ul>
<li><code>Access Type</code>: <code>confidential</code></li>
<li><code>Standard Flow Enabled</code>: <code>off</code></li>
<li><code>Implicit Flow enabled</code>: <code>off</code></li>
<li><code>Direct Grants Enabled</code>: <code>on</code></li>
<li><code>Authorization Enabled</code>: <code>on</code>
<ul>
<li>this will enable <code>Service Accounts</code></li>
</ul>
</li>
<li>URLs are pre-populated and good for what we need to do</li>
<li>Click Save
<ul>
<li>the <code>Authorization</code> tab will appear</li>
</ul>
</li>
</ul>
<h3 id="scope-tab"><a href="#scope-tab" class="anchor-link">§</a>scope tab</h3>
<p>Great, now go to <code>Scope</code> tab.</p>
<ul>
<li><code>Full Scope Allowed</code>: <code>off</code></li>
</ul>
<p><code>Realm Roles</code> will appear. Select all <code>Available Roles</code> and click <code>Add selected</code> button.</p>
<h3 id="authorization-tab"><a href="#authorization-tab" class="anchor-link">§</a>authorization tab</h3>
<p>This is where things get a little bit involved. A bunch of new tabs have appeared.</p>
<h4 id="authorization--settings"><a href="#authorization--settings" class="anchor-link">§</a>authorization / settings</h4>
<ul>
<li><code>Policy Enforcement Mode</code>: <code>Enforcing</code></li>
<li><code>Decision Strategy</code>: <code>Unanimous</code></li>
<li><code>Remote Resource Management</code>: <code>off</code></li>
</ul>
<p>Click <code>Save</code>.</p>
<h4 id="authorization--policies"><a href="#authorization--policies" class="anchor-link">§</a>authorization / policies</h4>
<ul>
<li>delete <code>Default Policy</code></li>
<li>For each Customer, create a <code>Role based</code> policy (dropdown on the right side of the page):
<ul>
<li><code>CustomerA</code>:
<ul>
<li><code>Name</code>: <code>Policy-CustomerA</code></li>
<li><code>Realm Roles</code>: type and select: <code>CustomerA</code> (click <code>Required</code></li>
<li><code>Logic</code>: <code>Positive</code></li>
</ul>
</li>
<li><code>CustomerB</code>:
<ul>
<li><code>Name</code>: <code>Policy-CustomerB</code></li>
<li><code>Realm Roles</code>: type and select: <code>CustomerB</code> (click <code>Required</code>)</li>
<li><code>Logic</code>: <code>Positive</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/policies.png" alt="authorization services / policies"></p>
<h4 id="authorization--authorization-scopes"><a href="#authorization--authorization-scopes" class="anchor-link">§</a>authorization / authorization scopes</h4>
<p>Create a scope for each customer:</p>
<ul>
<li>for <code>CustomerA</code>: <code>customer-a</code></li>
<li>for <code>CustomerB</code>: <code>customer-b</code></li>
</ul>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/authorization-scopes.png" alt="authorization services / authorization scopes"></p>
<h4 id="authorization--resources"><a href="#authorization--resources" class="anchor-link">§</a>authorization / resources</h4>
<ul>
<li>delete <code>Default Resource</code></li>
</ul>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/delete-default-resource.png" alt="delete default resource"></p>
<p>Create a resource for each customer:</p>
<ul>
<li><code>CustomerA</code>:
<ul>
<li><code>Name</code>: <code>CustomerA</code></li>
<li><code>Display Name</code>: <code>Customer A Resource</code></li>
<li><code>Type</code>: <code>urn:customers:resources:customer</code></li>
<li><code>URI</code>: <code>/customers/CustomerA</code> (irrelevant for our use case)</li>
<li><code>Scope</code>: <code>customer-a</code></li>
<li><code>User Managed Access</code>: <code>off</code></li>
</ul>
</li>
<li><code>CustomerB</code>:
<ul>
<li><code>Name</code>: <code>CustomerB</code></li>
<li><code>Display Name</code>: <code>Customer B Resource</code></li>
<li><code>Type</code>: <code>urn:customers:resources:customer</code></li>
<li><code>URI</code>: <code>/customers/CustomerB</code> (irrelevant for our use case)</li>
<li><code>Scope</code>: <code>customer-b</code></li>
<li><code>User Managed Access</code>: <code>off</code></li>
</ul>
</li>
</ul>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/resources.png" alt="resources"></p>
<h4 id="authorization--permissions"><a href="#authorization--permissions" class="anchor-link">§</a>authorization / permissions</h4>
<p>Finally, create permissions. One <code>Scope-Based</code> permission per customer. As with policies, the option to add is on the right side of the screen, a dropdown.</p>
<ul>
<li><code>CustomerA</code>:
<ul>
<li><code>Name</code>: <code>CustomerA Permission</code></li>
<li><code>Resource</code>: <code>CustomerA</code></li>
<li><code>Scope</code>: <code>customer-a</code></li>
<li><code>Apply policy</code>: <code>Select Existing Policy</code>: <code>Policy-CustomerA</code></li>
<li><code>Decision strategy</code>: <code>Unanimous</code></li>
</ul>
</li>
<li><code>CustomerB</code>:
<ul>
<li><code>Name</code>: <code>CustomerB Permission</code></li>
<li><code>Resource</code>: <code>CustomerB</code></li>
<li><code>Scope</code>: <code>customer-b</code></li>
<li><code>Apply policy</code>: <code>Select Existing Policy</code>: <code>Policy-CustomerB</code></li>
<li><code>Decision strategy</code>: <code>Unanimous</code></li>
</ul>
</li>
</ul>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/permissions.png" alt="permissions"></p>
<p>We have finished setting up Authorization services.</p>
<p>Before we can play around, we will add our Support Team Member user to Keycloak.</p>
<h2 id="create-a-user"><a href="#create-a-user" class="anchor-link">§</a>create a user</h2>
<p>In the left Keycloak menu, click <code>Users</code>. On the right hand side of the <code>Lookup</code> header, there is an <code>Add user</code> button. Click it. Populate the fields as follows:</p>
<ul>
<li><code>Username</code>: <code>member@service-team</code></li>
<li><code>Email</code>: <code>member@service-team</code></li>
<li><code>First name</code>: <code>Member</code></li>
<li><code>Last name</code>: <code>ServiceTeam</code></li>
<li><code>User enabled</code>: <code>on</code></li>
<li><code>Email verified</code>: <code>on</code></li>
</ul>
<p>Click <code>Save</code>.</p>
<h3 id="user-credentials"><a href="#user-credentials" class="anchor-link">§</a>user credentials</h3>
<p>We are going to be interacting with Keycloak via command line only and the purpose of this exercise is to validate specific user&rsquo;s resource access. Hence, we need to set the password for the user because we will use <strong>Resource owner credentials grant</strong> <a href="http://tools.ietf.org/html/rfc6749#section-4.3" target="_blank" rel="noopener">Section 4.3</a>.</p>
<ul>
<li><code>Set password</code>: <code>password123</code></li>
<li><code>Temporary</code>: <code>off</code></li>
</ul>
<p>Click <code>Set password</code>.</p>
<p><img src="/assets/posts/2020-09-05-introduction-to-keycloak-authorization-services/user-password.png" alt="user password"></p>
<h2 id="fetch-the-openid-client-credentials"><a href="#fetch-the-openid-client-credentials" class="anchor-link">§</a>fetch the OpenID Client credentials</h2>
<p>Once again, in the left Keycloak menu, click <code>Clients</code>. Find <code>customers</code> client and click on it. Go to <code>Credentials</code> tab. Your <code>client id</code> is the client name—<code>customers</code>. The <code>secret</code> is displayed. Copy it and in the terminal, export as:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEYCLOAK_CLIENT_SECRET</span><span class="o">=</span>...
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Also, export the username and password.</p>
<p><strong>This is obviously done only for the sake of this tutorial. Don&rsquo;t export passwords or secrets like this in a production system. Really, never. Use something like Ansible Vault or HashiCorp Vault to store secrets.</strong></p>
<p>Even storing the password in the file and using:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">$(</span>cat /path/to/the/password/file<span class="k">)</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>would be better than what we do below. But now&hellip;</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">USER_NAME</span><span class="o">=</span>member@service-team
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">USER_PASSWORD</span><span class="o">=</span>password123
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="play-time"><a href="#play-time" class="anchor-link">§</a>play time!</h2>
<blockquote>
<p>If you receive an <code>Invalid bearer token</code> error at any step further, you need to obtain a new access token. It simply means the token has expired.</p></blockquote>
<p>Whoa, that was a lot of stuff to set up! The good news, all that can be easily automated. But it was important to execute this once manually to see what goes where. As we have done it, we are ready for some real action!</p>
<p>In the same terminal window where we exported the secret and user password, let&rsquo;s export the token URL so the examples below are a little bit more concise.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEYCLOAK_TOKEN_URL</span><span class="o">=</span>http://127.0.0.1:28080/auth/realms/multi-customer/protocol/openid-connect/token
</span></span></code></pre></td></tr></table></div>
</div>
</div><blockquote>
<p>You can introspect your realm by going to<br>
<a href="http://127.0.0.1:28080/auth/realms/multi-customer/.well-known/openid-configuration/" target="_blank" rel="noopener">http://localhost:28080/auth/realms/multi-customer/.well-known/openid-configuration/</a>.</p></blockquote>
<p><strong>Keep in mind</strong>, we haven&rsquo;t assigned any roles to <code>member@service-team</code> user yet, other than what&rsquo;s the default for Keycloak: <code>offline_access</code> and <code>uma_authorization</code>.</p>
<p>Let&rsquo;s see if we can obtain an access token:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -u customers:<span class="si">${</span><span class="nv">KEYCLOAK_CLIENT_SECRET</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -k -d <span class="s2">&#34;grant_type=password&amp;username=</span><span class="si">${</span><span class="nv">USER_NAME</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">${</span><span class="nv">USER_PASSWORD</span><span class="si">}</span><span class="s2">&amp;scope=email profile&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -H <span class="s2">&#34;Content-Type:application/x-www-form-urlencoded&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span> -r
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The outcome should be similar to this:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJSUzI1NiIsIn...iWNlvIOVA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJIUzI1N...K6O5QoSDl_t2JA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;bearer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session_state&#34;</span><span class="p">:</span> <span class="s2">&#34;c0536fd1-35f3-4563-b1a4-006f59da7465&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scope&#34;</span><span class="p">:</span> <span class="s2">&#34;profile email&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>We will always need the value of the access token so further, we will export the access token as an environment variables directly from curl output using <code>jq</code>.</p>
<p>Okay, let&rsquo;s get another token then&hellip;</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">access_token</span><span class="o">=</span><span class="sb">`</span>curl --silent -u customers:<span class="si">${</span><span class="nv">KEYCLOAK_CLIENT_SECRET</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -k -d <span class="s2">&#34;grant_type=password&amp;username=</span><span class="si">${</span><span class="nv">USER_NAME</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">${</span><span class="nv">USER_PASSWORD</span><span class="si">}</span><span class="s2">&amp;scope=email profile&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -H <span class="s2">&#34;Content-Type:application/x-www-form-urlencoded&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="p">|</span> jq <span class="s1">&#39;.access_token&#39;</span> -r<span class="sb">`</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="uma-tickets"><a href="#uma-tickets" class="anchor-link">§</a>UMA tickets</h3>
<blockquote>
<p><strong>From Wikipedia:</strong><br>
UMA stands for <em>User Managed Access</em> and is an OAuth based access management protocol standard.<br>
It enables a resource owner to control the authorization of data sharing and other protected-resource access made between online services on the owner’s behalf or with the owner’s authorization by an autonomous requesting party. <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">[2]</a></sup></p></blockquote>
<p>We can now ask Keycloak to tell us which resources the user has access to.</p>
<p>In order to do so, we have to ask for an UMA token by sending a post request to the realm token endpoint with our existing access token and a special grant type: <code>urn:ietf:params:oauth:grant-type:uma-ticket</code>.</p>
<p>The <code>audience</code> parameter is required.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>We receive the response:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;error&#34;</span><span class="p">:</span><span class="s2">&#34;access_denied&#34;</span><span class="p">,</span><span class="nt">&#34;error_description&#34;</span><span class="p">:</span><span class="s2">&#34;not_authorized&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>I know it does not look like it but this is a <strong>Great News</strong>!</p>
<p>The reason why we have received this answer is because we have removed the <code>Default Resource</code> and not assigned any customer roles to our user. Let&rsquo;s change that.</p>
<p>Go to the user roles (<code>Manage</code> / <code>Users</code> (left menu in Keycloak) / <code>member@service-team</code> / <code>Role Mappings</code>) and assign <code>CustomerA</code> role.</p>
<p>Obtain another access token:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">access_token</span><span class="o">=</span><span class="sb">`</span>curl --silent -u customers:<span class="si">${</span><span class="nv">KEYCLOAK_CLIENT_SECRET</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -k -d <span class="s2">&#34;grant_type=password&amp;username=</span><span class="si">${</span><span class="nv">USER_NAME</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">${</span><span class="nv">USER_PASSWORD</span><span class="si">}</span><span class="s2">&amp;scope=email profile&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -H <span class="s2">&#34;Content-Type:application/x-www-form-urlencoded&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="p">|</span> jq <span class="s1">&#39;.access_token&#39;</span> -r<span class="sb">`</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>and rerun the previous command:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The response is different! Better! We can look at what we are interested in:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;upgraded&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGci...7I_pA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGc...QYko&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Copy the <code>access_token</code> from this response and decode it in <code>jwt.io</code> (or any other tool, it&rsquo;s just three different <code>base64</code> encoded strings concatenated with a <code>dot</code>). Look at <code>realm_access</code> and <code>authorization</code> claims. They are like this:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl">  <span class="s2">&#34;realm_access&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;roles&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CustomerA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;offline_access&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;uma_authorization&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="err">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;authorization&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;permissions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;scopes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;customer-a&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rsid&#34;</span><span class="p">:</span> <span class="s2">&#34;715f6cc5-8ca7-44e4-a8ce-924493db76b1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rsname&#34;</span><span class="p">:</span> <span class="s2">&#34;CustomerA&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="err">,</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>This response tells us that the user behind the <code>Bearer</code> token is allowed access to <code>CustomerA</code> using <code>customer-a</code> scope. The <code>realm_access.roles</code> claim contains the <code>CustomerA</code> role but we get that info in a regular access token already.</p>
<p>However, there is no <code>CustomerB</code> on this list.</p>
<p>Fair enough, let&rsquo;s ask th server Keycloak directly if this user has access to <code>CustomerB</code>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerB#customer-b&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The response is:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;access_denied&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error_description&#34;</span><span class="p">:</span> <span class="s2">&#34;not_authorized&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Correct! The user does not have access to the <code>CustomerB</code>. What if we don&rsquo;t specify a scope?</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerB&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The response is:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;access_denied&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error_description&#34;</span><span class="p">:</span> <span class="s2">&#34;not_authorized&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Correct again! But let&rsquo;s verify that this indeed works for <code>CustomerA</code>, the user should have access:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerA&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>We receive:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;upgraded&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJSUzI...7dlw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOi...QaM2ZA9nY1M&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Which is correct. Can the user request <code>CustomerA</code> resource with incorrect scope?</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerA#customer-b&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;invalid_resource&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error_description&#34;</span><span class="p">:</span> <span class="s2">&#34;Resource with id [CustomerA] does not exist.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Correct, the resource does not exist with this scope! So let&rsquo;s use the correct scope again, just to make sure everything is fine:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerA#customer-a&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Once again, we get:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;upgraded&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJSUzI1N...p3tFd4cjH1UAGOlY0g_U3b5Lj19zH4I3wkzA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJIUzI1N...FeEV8qFCVLM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Phew. So far so good. Now, go to the user <code>Role Mappings</code> and assign <code>CustomerB</code> role. The user now has <code>offline_access</code>, <code>uma_authorization</code>, <code>CustomerA</code> and <code>CustomerB</code> roles assigned.</p>
<p>We require a new token:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">access_token</span><span class="o">=</span><span class="sb">`</span>curl --silent -u customers:<span class="si">${</span><span class="nv">KEYCLOAK_CLIENT_SECRET</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -k -d <span class="s2">&#34;grant_type=password&amp;username=member@service-team&amp;password=</span><span class="si">${</span><span class="nv">USER_PASSWORD</span><span class="si">}</span><span class="s2">&amp;scope=email profile&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -H <span class="s2">&#34;Content-Type:application/x-www-form-urlencoded&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="p">|</span> jq <span class="s1">&#39;.access_token&#39;</span> -r<span class="sb">`</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Do we now have the permission to access <code>CustomerB</code>? Well, let&rsquo;s find out:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerB&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Gives us:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;upgraded&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJSUzI1NiIsI...n8AC51T1AMwDtoqfCEXrdwcrQ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJIUz...RG3zFus&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>And with the scope?</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent -X POST <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;audience=customers&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data <span class="s2">&#34;permission=CustomerB#customer-b&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;upgraded&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2...KxKyysheoaDgwRaVkyl158flOD5CtyHbjKFkWhA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOi...1tBGk6vebI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Cool! Everything works. Our regular user can now see all customers he has been given access to.</p>
<h2 id="top-secret-customer"><a href="#top-secret-customer" class="anchor-link">§</a>top secret customer</h2>
<p>Eventually, we may decide that we should be able to discover all <code>customer</code> resources available in our Keycloak resource server. What would be unfortunate though, if our regular user could see customers who they should never be aware of.</p>
<p>Frankly speaking, we could have a <code>TopSecretCustomer</code> in the system and nobody, <strong>ever</strong>, except of the <code>TopSecretCustomer</code> (and us) should be aware of their existence.</p>
<p>Keycloak offers something called a resource set. Resource set allows us to introspect resources available on our resource server.</p>
<p>In order to access the resource set, the user must have the <code>uma_protection</code> role of the client assigned. Which is great. This implies we can just create a dedicated user with access to the resource set. Separation of concern at work! &hellip;</p>
<p>Let&rsquo;s do so.</p>
<h3 id="listing-available-customers"><a href="#listing-available-customers" class="anchor-link">§</a>listing available customers</h3>
<p>Go to <code>Manage</code> / <code>Users</code> and click <code>Add user</code> once again. Set the following:</p>
<ul>
<li><code>Username</code>: <code>supervisor@company</code></li>
<li><code>Email</code>: <code>supervisor@company</code></li>
<li><code>First name</code>: <code>Supervisor</code></li>
<li><code>Last name</code>: <code>Company</code></li>
<li><code>User enabled</code> and <code>Email verified</code>: <code>on</code></li>
</ul>
<p>Click <code>Save</code>.</p>
<p>Set the password. Go to <code>Credentials</code> tab and set the password to <code>password123!</code>, Temporary: <code>off</code>. Click <code>Set password</code>. Now, go to <code>Role Mappings</code> and in the <code>Client Roles</code>, select <code>customers</code> client. Select <code>uma_protection</code> from <code>Available roles</code> and click <code>Add selected</code>.</p>
<p>On the command line, we can now list our customers. First, more environment variables to export.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ADMIN_USER_NAME</span><span class="o">=</span>supervisor@company
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ADMIN_USER_PASSWORD</span><span class="o">=</span><span class="s1">&#39;password123!&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEYCLOAK_RESOURCE_SET_URL</span><span class="o">=</span>http://127.0.0.1:28080/auth/realms/multi-customer/authz/protection/resource_set
</span></span></code></pre></td></tr></table></div>
</div>
</div><blockquote>
<p>As with well known OpenID configuration, you can introspect well known UMA configuration by going to<br>
<a href="http://127.0.0.1:28080/auth/realms/multi-customer/.well-known/uma2-configuration/" target="_blank" rel="noopener">http://localhost:28080/auth/realms/multi-customer/.well-known/uma2-configuration/</a></p></blockquote>
<p>We need an access token for the supervisor user:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">supervisor_access_token</span><span class="o">=</span><span class="sb">`</span>curl --silent -u customers:<span class="si">${</span><span class="nv">KEYCLOAK_CLIENT_SECRET</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -k -d <span class="s2">&#34;grant_type=password&amp;username=</span><span class="si">${</span><span class="nv">ADMIN_USER_NAME</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">${</span><span class="nv">ADMIN_USER_PASSWORD</span><span class="si">}</span><span class="s2">&amp;scope=email profile&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -H <span class="s2">&#34;Content-Type:application/x-www-form-urlencoded&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">KEYCLOAK_TOKEN_URL</span><span class="si">}</span> <span class="p">|</span> jq <span class="s1">&#39;.access_token&#39;</span> -r<span class="sb">`</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The token received above is technically a <strong>protection API token</strong> (PAT). PAT is a special OAuth2 access token with a scope defined as <code>uma_protection</code>. <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">[3]</a></sup></p>
<p>We can query for available customers like this:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">supervisor_access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_RESOURCE_SET_URL</span><span class="si">}</span>?type<span class="o">=</span>urn:customers:resources:customer <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;715f6cc5-8ca7-44e4-a8ce-924493db76b1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;00f34b81-c45b-4e28-b267-45fad4e48b4d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The above request queried the resource set with the type filter set to <code>urn:customers:resources:customer</code>.</p>
<blockquote>
<p>More about querying the resource set in Keycloak Authorization Services Guide, <a href="https://www.keycloak.org/docs/latest/authorization_services/#_service_protection_resources_api" target="_blank" rel="noopener">Managing Resources</a>.</p></blockquote>
<p>Let&rsquo;s check if our filter is working:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">supervisor_access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_RESOURCE_SET_URL</span><span class="si">}</span>?type<span class="o">=</span>urn:customers:resources:kitten <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[]</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>It is working! Let&rsquo;s focus on the first response:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;715f6cc5-8ca7-44e4-a8ce-924493db76b1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;00f34b81-c45b-4e28-b267-45fad4e48b4d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>We can query each individual resource:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">supervisor_access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_RESOURCE_SET_URL</span><span class="si">}</span>/715f6cc5-8ca7-44e4-a8ce-924493db76b1 <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Gives us:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CustomerA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;urn:customers:resources:customer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;owner&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;95027cdf-4044-4622-bfdb-19ba8f7db65c&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ownerManagedAccess&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;Customer A Resource&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;715f6cc5-8ca7-44e4-a8ce-924493db76b1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;uris&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/customers/CustomerA&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;resource_scopes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;customer-a&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scopes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;customer-a&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>and:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">supervisor_access_token</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="si">${</span><span class="nv">KEYCLOAK_RESOURCE_SET_URL</span><span class="si">}</span>/00f34b81-c45b-4e28-b267-45fad4e48b4d <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>results in:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CustomerB&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;urn:customers:resources:customer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;owner&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;95027cdf-4044-4622-bfdb-19ba8f7db65c&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ownerManagedAccess&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;Customer B Resource&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;00f34b81-c45b-4e28-b267-45fad4e48b4d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;uris&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/customers/CustomerB&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;resource_scopes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;customer-b&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scopes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;customer-b&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>We could now easily create an application to find and return all available Customers. All with Keycloak and without querying any database directly.</p>
<h2 id="conclusion"><a href="#conclusion" class="anchor-link">§</a>conclusion</h2>
<p>Keycloak is a very versatile tool and can be easily used as a single source of truth for authentication, single sign-on and authorization within an organization. This article only touches a tip of an iceberg but it presents to the reader a real-world, useful scenario of using Keycloak as a driver for multi-tenant single sign-on.</p>
<h2 id="further-reading"><a href="#further-reading" class="anchor-link">§</a>further reading</h2>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/authorization_services/" target="_blank" rel="noopener">Authorization Services Guide</a>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/authorization_services/#_service_user_managed_access" target="_blank" rel="noopener">User Managed Access</a></li>
<li><a href="https://www.keycloak.org/docs/latest/authorization_services/#_service_protection_resources_api" target="_blank" rel="noopener">Managing Resources</a></li>
</ul>
</li>
<li><a href="https://docs.kantarainitiative.org/uma/wg/rec-oauth-uma-grant-2.0.html" target="_blank" rel="noopener">User-Managed Access (UMA) 2.0 Grant for OAuth 2.0 Authorization</a></li>
</ul>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://gruchalski.com/posts/2020-09-03-keycloak-with-docker-compose/" target="_blank" rel="noopener">Keycloak with Docker Compose</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:2">
<p><a href="https://en.wikipedia.org/wiki/User-Managed_Access" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/User-Managed_Access</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:3">
<p><a href="https://www.keycloak.org/docs/latest/authorization_services/#_service_protection_whatis_obtain_pat" target="_blank" rel="noopener">What is a PAT and how to obtain it</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
</ol>
</div>

            </div>

            
    
    



        </article>

        

        


        


        <div class="post-share">

        

        <div class="share-items">

            
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=https://gruchalski.com/posts/2020-09-05-introduction-to-keycloak-authorization-services/&amp;text=Introduction%20to%20Keycloak%20Authorization%20Services&amp;hashtags=Keycloak,Iam,Multi-Tenant,Sso,Uma,&amp;via=%25!s%28%3cnil%3e%29" title="Share on Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            

            
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://gruchalski.com/posts/2020-09-05-introduction-to-keycloak-authorization-services/&amp;title=Introduction%20to%20Keycloak%20Authorization%20Services&amp;summary=Investigating%20Keycloak%20Authorization%20Services%20using%20a%20real-world%20back%20office%20application%20scenario&amp;source=gruchalski.com" title="Share on LinkedIn" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            

            

            

            

            

            
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="Share via QR Code"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/gruchalski.com\/posts\/2020-09-05-introduction-to-keycloak-authorization-services\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">See Also:<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/2020-09-16-keycloak-authorization-services-rpt-permissions-or-a-decision-only/" class="related-link">Keycloak Authorization Services - RPT, permissions or a decision only</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2020-09-06-keycloak-authorization-services-decision-only/" class="related-link">Keycloak Authorization Services - retrieving the decision only</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2020-09-03-keycloak-with-docker-compose/" class="related-link">Keycloak With Docker Compose</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2022-06-18-streaming-keycloak-events/" class="related-link">Streaming Keycloak events</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2021-04-10-ory-reference-docker-compose-and-thoughts-on-the-platform/" class="related-link">ORY reference Docker Compose and thoughts on the platform</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/keycloak/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Keycloak</a>
                
            
                
                
                
                
                    
                    <a href="/tags/iam/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Iam</a>
                
            
                
                
                
                
                    
                    <a href="/tags/multi-tenant/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Multi-Tenant</a>
                
            
                
                
                
                
                    
                    <a href="/tags/sso/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Sso</a>
                
            
                
                
                
                
                    
                    <a href="/tags/uma/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Uma</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/posts/2020-09-06-keycloak-authorization-services-decision-only/" rel="prev">&lt; Keycloak Authorization Services - retrieving the decision only</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/posts/2020-09-03-keycloak-with-docker-compose/" rel="next">Keycloak With Docker Compose &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;2015–2025&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://en.wikipedia.org/wiki/Canonical_link_element" target="_blank" rel="noopener">reposting requires attribution, <strong>use canonical links</strong> »</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:radek@gruchalski.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/radekg" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://linkedin.com/in/radgruchalski" target="_blank" rel="external noopener" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon social-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        

        








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
