<!DOCTYPE html>
<html lang="en">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.148.2"><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Istio VM workloads | gruchalski.com</title>

    <link rel="stylesheet" href="/css/meme.min.fe3b4eabe26125d7716d7271d1dcc928f862e422b39cc80a8c45354f89084434.css"/>

    
    
        <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js" defer></script><script src="/js/meme.min.1321582b41a9fdb1a15023a3d3204fa013ace575e4c594c9dbc43078a016fce0.js"></script>

    

    <link rel="stylesheet" href="/assets/fonts/amaranth.css?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="/assets/fonts/amaranth.css?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" /></noscript>

    <meta name="author" content="Radek Gruchalski" /><meta name="description" content="setting up a proof-of-concept connectivity with a VM in an Istio mesh" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="gruchalski.com" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="gruchalski.com" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    
        <link rel="canonical" href="https://gruchalski.com/posts/2023-11-02-istio-external-workloads/" />
    

    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2023-11-02T00:00:00+02:00",
        "dateModified": "2023-11-13T19:05:29+01:00",
        "url": "https://gruchalski.com/posts/2023-11-02-istio-external-workloads/",
        "headline": "Istio VM workloads",
        "description": "setting up a proof-of-concept connectivity with a VM in an Istio mesh",
        "inLanguage" : "en",
        "articleSection": "posts",
        "wordCount":  3266 ,
        "image": "https://gruchalski.com/icons/apple-touch-icon.png",
        "author": {
            "@type": "Person",
            "url": "https://gruchalski.com/",
            
        },
        "license": "[reposting requires attribution, **use canonical links** »](https://en.wikipedia.org/wiki/Canonical_link_element)",
        "publisher": {
            "@type": "Organization",
            "name": "gruchalski.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://gruchalski.com/icons/apple-touch-icon.png"
            },
            "url": "https://gruchalski.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://gruchalski.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary" />


    



<meta property="og:title" content="Istio VM workloads" />
<meta property="og:description" content="setting up a proof-of-concept connectivity with a VM in an Istio mesh" />
<meta property="og:url" content="https://gruchalski.com/posts/2023-11-02-istio-external-workloads/" />
<meta property="og:site_name" content="gruchalski.com" />
<meta property="og:locale" content="en" /><meta property="og:image" content="https://gruchalski.com/icons/apple-touch-icon.png" />
        <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2023-11-02T00:00:00&#43;02:00" />
    <meta property="article:modified_time" content="2023-11-13T19:05:29&#43;01:00" />
    
    <meta property="article:section" content="posts" />



    
    

    
    <script async 
        src="https://analytics.svcs.sh/script.js"
        data-website-id="791140b3-1642-400d-82b9-6adcd1095688"
        data-do-not-track="true"
        data-domains="gruchalski.com"></script>

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">gruchalski.com</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">posts</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="icon code-branch"><path d="M384 144c0-44.2-35.8-80-80-80s-80 35.8-80 80c0 36.4 24.3 67.1 57.5 76.8-.6 16.1-4.2 28.5-11 36.9-15.4 19.2-49.3 22.4-85.2 25.7-28.2 2.6-57.4 5.4-81.3 16.9v-144c32.5-10.2 56-40.5 56-76.3 0-44.2-35.8-80-80-80S0 35.8 0 80c0 35.8 23.5 66.1 56 76.3v199.3C23.5 365.9 0 396.2 0 432c0 44.2 35.8 80 80 80s80-35.8 80-80c0-34-21.2-63.1-51.2-74.6 3.1-5.2 7.8-9.8 14.9-13.4 16.2-8.2 40.4-10.4 66.1-12.8 42.2-3.9 90-8.4 118.2-43.4 14-17.4 21.1-39.8 21.6-67.9 31.6-10.8 54.4-40.7 54.4-75.9zM80 64c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm0 384c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16zm224-320c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16z"/></svg><span class="menu-item-name">categories</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">tags</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">about</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/privacy/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" class="icon info"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"/></svg><span class="menu-item-name">privacy</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href=""></a>
                </li>
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="default" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">Istio VM workloads</h1>

            

            
                <div class="post-description p-summary">setting up a proof-of-concept connectivity with a VM in an Istio mesh</div>
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2023-11-02T00:00:00&#43;02:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;November 2, 2023</time>
    
    
    
    
        
        
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;3266</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;16&nbsp;mins</span>
    
    
    
</div>

            

            

            <div class="post-body e-content">
              <div class="infobox">
<p><strong>Update 2023.11.10</strong>: The original post was long and contained a lot of code, right in your face.<br>
Since I tidied up <a href="https://github.com/radekg/istio-vms" target="_blank" rel="noopener">the accompanying repository</a>, I am making the following changes:</p>
<ul>
<li>The default ingress is turned on.</li>
<li>Removing large code blocks, replacing them with invocation and functional description.</li>
<li>Splitting the VM installation process into two separate steps: VM create and bootstrap.</li>
</ul>
<p><strong>Update 2023.11.13</strong>: I have updated the Istio installation:</p>
<ul>
<li>Use an explicit revision during installation revision, adapt components to use the revision.</li>
<li>Work documented in the <a href="https://github.com/radekg/istio-vms/pull/7" target="_blank" rel="noopener">Revisioned Istio</a> pull request.</li>
</ul>
</div>
<p>I am going to connect a VM to the Istio mesh running in the Kubernetes cluster.</p>
<p>I will need:</p>
<ul>
<li>A VM.</li>
<li>A Kubernetes cluster.</li>
<li>Containers.</li>
</ul>
<p>This is not a job for <em>KinD</em> because I need a VM. Since I&rsquo;m on a macOS, it&rsquo;s <em>Multipass</em> for me today.</p>
<p>I am going to run:</p>
<ul>
<li>A <em>k3s</em> cluster on <em>Multipass</em>.</li>
<li>A VM on <em>Multipass</em>, same network as the <em>k3s</em> cluster.</li>
</ul>
<p>After setting up the <em>k3s</em> cluster I follow the steps from Istio documentation: <a href="https://istio.io/latest/docs/setup/install/virtual-machine/" target="_blank" rel="noopener">Virtual Machine Installation</a><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">[1]</a></sup>.</p>
<p>The outcome is a working Istio mesh with a VM in the mesh supporting bidirectional traffic, and a short dive into network policies.</p>
<div>
    <h2>table of contents</h2>
    <nav id="TableOfContents">
  <ol>
    <li><a href="#tools">tools</a></li>
    <li><a href="#working-directory">working directory</a></li>
    <li><a href="#environment-configuration">environment configuration</a></li>
    <li><a href="#setting-up-the-k3s-cluster">setting up the <em>k3s</em> cluster</a></li>
    <li><a href="#setting-up-the-client">setting up the client</a></li>
    <li><a href="#verify-the-cluster">verify the cluster</a></li>
    <li><a href="#install-istioctl">install istioctl</a></li>
    <li><a href="#istio-installation">istio installation</a></li>
    <li><a href="#eastwest-gateway"><em>eastwest</em> gateway</a></li>
    <li><a href="#create-the-vm">create the vm</a></li>
    <li><a href="#the-workload-group">the workload group</a>
      <ol>
        <li><a href="#workload-group-ca_addr">workload group ca_addr</a></li>
      </ol>
    </li>
    <li><a href="#the-vm-arm64-bootstrap-caveat">the vm: <code>arm64</code> bootstrap caveat</a>
      <ol>
        <li><a href="#the-deb-package">the <em>deb</em> package</a></li>
        <li><a href="#arm64-binaries"><code>arm64</code> binaries</a></li>
      </ol>
    </li>
    <li><a href="#bootstrap-the-vm">bootstrap the vm</a></li>
    <li><a href="#validate-the-vm">validate the vm</a>
      <ol>
        <li><a href="#validate-dns-resolution">validate DNS resolution</a></li>
        <li><a href="#validating-communication">validating communication</a>
          <ol>
            <li><a href="#create-and-configure-the-namespace">create and configure the namespace</a>
              <ol>
                <li><a href="#on-amd64-host">on <code>amd64</code> host</a></li>
                <li><a href="#on-arm64-host">on <code>arm64</code> host</a></li>
              </ol>
            </li>
            <li><a href="#hello-world-pods-are-running">hello world pods are running</a></li>
            <li><a href="#checking-vm-to-mesh-connectivity">checking vm to mesh connectivity</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#routing-mesh-traffic-to-the-vm">routing mesh traffic to the vm</a>
      <ol>
        <li><a href="#workload-entry-is-unhealthy">workload entry is unhealthy</a></li>
        <li><a href="#fix-it-by-starting-the-workload">fix it by starting the workload</a></li>
        <li><a href="#verify-connectivity-with-curl">verify connectivity with <code>curl</code></a></li>
      </ol>
    </li>
    <li><a href="#enable-strict-tls">enable strict tls</a></li>
    <li><a href="#network-policies">network policies</a>
      <ol>
        <li><a href="#caveat-cannot-select-a-workload-entry-in-a-network-policy">caveat: cannot select a workload entry in a network policy</a></li>
        <li><a href="#guarding-the-vm-from-the-source-of-traffic-namespace">guarding the vm from the source of traffic namespace</a></li>
        <li><a href="#network-boundary-for-network-policies">network boundary for network policies</a></li>
      </ol>
    </li>
    <li><a href="#cleaning-up">cleaning up</a></li>
    <li><a href="#summary">summary</a></li>
  </ol>
</nav>
</div>
<h2 id="tools"><a href="#tools" class="anchor-link">§</a>tools</h2>
<p>Besides the standard <code>kubectl</code>:</p>
<ul>
<li><code>multipass</code>: macOS <code>brew install multipass</code>, Linux <a href="https://multipass.run/docs/installing-on-linux" target="_blank" rel="noopener">official instructions</a><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">[2]</a></sup> or follow instructions for your distribution,</li>
<li><code>git</code>: to fetch the additional data,</li>
<li><code>yq</code>: follow <a href="https://github.com/mikefarah/yq#install" target="_blank" rel="noopener">an official guide</a><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">[3]</a></sup>,</li>
<li><code>docker</code> or <code>podman</code> if you are on an <em>arm64-based</em> host,</li>
<li><code>istioctl</code>: instructions <a href="#install-istioctl">further in the article</a>.</li>
</ul>
<h2 id="working-directory"><a href="#working-directory" class="anchor-link">§</a>working directory</h2>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir -p ~/.project <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/.project
</span></span><span class="line"><span class="cl">git clone https://github.com/radekg/istio-vms.git .
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>This repository brings all tools used further in this post: shell programs and additional artifacts used during the rollout of the VM.</p>
<p>All commands further in this article assume that you remain in the newly created directory.</p>
<p>You can place it wherever you like, name it however you like, but that&rsquo;s <em><strong>the working directory</strong></em>.</p>
<h2 id="environment-configuration"><a href="#environment-configuration" class="anchor-link">§</a>environment configuration</h2>
<p>A few settings. Mainly:</p>
<ul>
<li>where&rsquo;s the data stored</li>
<li>the temp directory, some artifacts will be downloaded and extracted to disk</li>
<li>where&rsquo;s the <em>kubeconfig</em>?</li>
<li>settings:
<ul>
<li>operating system to use</li>
<li>Istio version to use</li>
<li>VM resource settings</li>
<li>VM-related configuration</li>
</ul>
</li>
</ul>
<p>Settings exist in the <em>run.env</em> file:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat run.env
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">env_base</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&#34;</span><span class="k">$(</span> dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">)</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">BIN_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">env_base</span><span class="si">}</span><span class="s2">/.bin/&#34;</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[[</span> <span class="s2">&#34;:</span><span class="nv">$PATH</span><span class="s2">:&#34;</span> !<span class="o">=</span> *<span class="s2">&#34;:</span><span class="si">${</span><span class="nv">BIN_DIR</span><span class="si">}</span><span class="s2">:&#34;</span>* <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">BIN_DIR</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DATA_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">env_base</span><span class="si">}</span><span class="s2">/.data/&#34;</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TEMP_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">env_base</span><span class="si">}</span><span class="s2">/.tmp/&#34;</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">/.kubeconfig&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTAINER_TOOL</span><span class="o">=</span><span class="si">${</span><span class="nv">CONTAINER_TOOL</span><span class="k">:-</span><span class="nv">docker</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Settings:</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RUN_OS</span><span class="o">=</span>22.04
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="si">${</span><span class="nv">ISTIO_VERSION</span><span class="k">:-</span><span class="nv">1</span><span class="p">.19.3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ISTIO_REVISION</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ISTIO_VERSION</span> <span class="p">|</span> tr <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;-&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Resources:</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CPU_MASTER</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CPU_WORKER</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DISK_MASTER</span><span class="o">=</span>4G
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DISK_WORKER</span><span class="o">=</span>8G
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MEM_MASTER</span><span class="o">=</span>1G
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MEM_WORKER</span><span class="o">=</span>8G
</span></span><span class="line"><span class="cl"><span class="c1"># VM-related configuration:</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ISTIO_NAMESPACE</span><span class="o">=</span><span class="si">${</span><span class="nv">ISTIO_NAMESPACE</span><span class="k">:-</span><span class="nv">istio</span><span class="p">-system</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ISTIO_MESH_ID</span><span class="o">=</span><span class="s2">&#34;vmmesh&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">WORKLOAD_VM_NAME</span><span class="o">=</span>vm-istio-external-workload
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ISTIO_CLUSTER</span><span class="o">=</span><span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VM_APP</span><span class="o">=</span><span class="s2">&#34;external-app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VM_NAMESPACE</span><span class="o">=</span><span class="s2">&#34;vmns&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SERVICE_ACCOUNT</span><span class="o">=</span><span class="s2">&#34;vmsa&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLUSTER_NETWORK</span><span class="o">=</span><span class="s2">&#34;kube-network&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VM_NETWORK</span><span class="o">=</span><span class="s2">&#34;vm-network&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># East-west gateway exposes different ports than the default ingress.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When both gateways need to be in use, and the cluster has one load balancer,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># these need to differ from the default ingress agteway.</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DEFAULT_PORT_STATUS</span><span class="o">=</span><span class="m">15021</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DEFAULT_PORT_TLS_ISTIOD</span><span class="o">=</span><span class="m">15012</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DEFAULT_PORT_TLS_WEBHOOK</span><span class="o">=</span><span class="m">15017</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">EWG_PORT_STATUS</span><span class="o">=</span><span class="m">15022</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">EWG_PORT_TLS_ISTIOD</span><span class="o">=</span><span class="m">15013</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">EWG_PORT_TLS_WEBHOOK</span><span class="o">=</span><span class="m">15018</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># However, if there&#39;s a run.env file in pwd, use that one:</span>
</span></span><span class="line"><span class="cl"><span class="nv">pwd</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pwd</span><span class="si">}</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env_base</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span> -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pwd</span><span class="si">}</span><span class="s2">/run.env&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pwd</span><span class="si">}</span><span class="s2">/run.env&#34;</span> <span class="o">&amp;&amp;</span> &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="nb">echo</span> <span class="s2">&#34;configured from </span><span class="si">${</span><span class="nv">pwd</span><span class="si">}</span><span class="s2">/run.env&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="setting-up-the-k3s-cluster"><a href="#setting-up-the-k3s-cluster" class="anchor-link">§</a>setting up the <em>k3s</em> cluster</h2>
<p>I am starting a <em>k3s</em> cluster with one control plane and two workers. <em>Traefik</em> is disabled because we use Istio. Also, the default <em>k3s</em> load balancer—<em>Klipper</em>—is on. This program requires <em>multipass</em>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.k3s.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Once the cluster is running, the kubeconfig is written to <em>.data/.kubeconfig</em>.</p>
<p>Please be mindful of the rather high resource requirement. Adjust as you see fit.</p>
<p>The cluster can be deleted with:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.k3s.sh --delete
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>and recreated (removed and created again) with:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.k3s.sh --recreate
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="setting-up-the-client"><a href="#setting-up-the-client" class="anchor-link">§</a>setting up the client</h2>
<p>To have your <em>kubectl</em> and and other tools use the correct <em>kubeconfig</em>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">source</span> run.env
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>This will set your <em>KUBECONFIG</em> environment variable and some other various settings.</p>
<h2 id="verify-the-cluster"><a href="#verify-the-cluster" class="anchor-link">§</a>verify the cluster</h2>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get nodes
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Something along the lines of:</p>
<pre tabindex="0"><code>NAME           STATUS   ROLES                  AGE     VERSION
k3s-master     Ready    control-plane,master   10m     v1.27.7+k3s1
k3s-worker-1   Ready    &lt;none&gt;                 9m26s   v1.27.7+k3s1
k3s-worker-2   Ready    &lt;none&gt;                 9m18s   v1.27.7+k3s1
</code></pre><h2 id="install-istioctl"><a href="#install-istioctl" class="anchor-link">§</a>install istioctl</h2>
<p>This program downloads <em>istioctl</em> for <em>ISTIO_VERSION</em> and <em>ISTIO_ARCH</em>, and places it in the <em>.bin/</em> directory.</p>
<ul>
<li><code>ISTIO_VERSION</code>: Istio version, default <code>1.19.3</code></li>
<li><code>ISTIO_ARCH</code>: one of <code>&lt; osx-arm64</code>, <code>osx-amd64</code>, <code>linux-armv7</code>, <code>linux-arm64</code>, <code>linux-amd64 &gt;</code>, default <code>osx-arm64</code></li>
</ul>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.istioctl.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Verify:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">istioctl version
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>no ready Istio pods in &#34;istio-system&#34;
1.19.3
</code></pre><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">which istioctl <span class="p">|</span> sed <span class="s1">&#39;s!&#39;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s1">&#39;/!!&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>.bin//istioctl
</code></pre><p>Double <code>/</code> is not a mistake.</p>
<h2 id="istio-installation"><a href="#istio-installation" class="anchor-link">§</a>istio installation</h2>
<p>This is where I start to follow the <a href="https://istio.io/latest/docs/setup/install/virtual-machine/" target="_blank" rel="noopener">Istio documentation</a><sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>This program installs and configures Istio from the <em>IstioOperator</em> resource. Install Istio:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.istio.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Verify:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get services -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ISTIO_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                 AGE
istiod-1-19-3   ClusterIP   10.43.255.139   &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP   39s
</code></pre><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">istioctl tag list --istioNamespace<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">ISTIO_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>TAG     REVISION NAMESPACES
default 1-19-3
</code></pre><h2 id="eastwest-gateway"><a href="#eastwest-gateway" class="anchor-link">§</a><em>eastwest</em> gateway</h2>
<p>This program installs the <em>eastwest</em> gateway. This program depends on <em>DEFAULT_PORT_*</em> and <em>EWG_PORT_*</em> environment variables.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.eastwest.gateway.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The outcome should be similar to this:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get services -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ISTIO_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span> -w
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP                                 PORT(S)                                                           AGE
istiod-1-19-3           ClusterIP      10.43.255.139   &lt;none&gt;                                      15010/TCP,15012/TCP,443/TCP,15014/TCP                             17m
istio-ingressgateway    LoadBalancer   10.43.217.75    192.168.64.60,192.168.64.61,192.168.64.62   15021:31941/TCP,80:30729/TCP,443:32187/TCP                        11m
istio-eastwestgateway   LoadBalancer   10.43.106.169   192.168.64.60,192.168.64.61,192.168.64.62   15022:31036/TCP,15443:32297/TCP,15013:31263/TCP,15018:32660/TCP   15s
</code></pre><p>If your <em>eastwest</em> gateway remains in the <em>pending</em> state, ensure that a <em>DEFAULT_PORT</em> is not equal to the corresponding <em>EWG_PORT</em>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get services -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ISTIO_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span> -w
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP                                 PORT(S)                                                           AGE
istiod-1-19-3           ClusterIP      10.43.255.139   &lt;none&gt;                                      15010/TCP,15012/TCP,443/TCP,15014/TCP                             17m
istio-ingressgateway    LoadBalancer   10.43.217.75    192.168.64.60,192.168.64.61,192.168.64.62   15021:31941/TCP,80:30729/TCP,443:32187/TCP                        11m
istio-eastwestgateway   LoadBalancer   10.43.106.169   &lt;pending&gt;                                   15021:31036/TCP,15443:32297/TCP,15013:31263/TCP,15018:32660/TCP   15s
</code></pre><p>In the example above, the problem is <em>15021:31036/TCP</em>: <em>15021</em> is already used by the default ingress gateway.</p>
<h2 id="create-the-vm"><a href="#create-the-vm" class="anchor-link">§</a>create the vm</h2>
<p>Before a workload group can be created, we need to have the VM because, in this case, the IP address is needed for the workload group. To create the VM:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.vm.create.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>This command supports <em>&ndash;delete</em> and <em>&ndash;recreate</em> flags. Only the <em>multipass</em> VM is manipulated. Other files remain on disk.</p>
<h2 id="the-workload-group"><a href="#the-workload-group" class="anchor-link">§</a>the workload group</h2>
<p>This program finds the VM IP address and uses it to create a <em>WorkloadGroup</em> Kubernetes resource. When ready, the program downloads all files required by the VM to join the mesh (<em>istioctl x workload entry configure</em>). Files are stored in <em>.data/workload-files</em>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.workload.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Verify:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat .data/workload-files/hosts
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>output similar to:</p>
<pre tabindex="0"><code>192.168.64.60 istiod-1-19-3.istio-system.svc
</code></pre><p>If there are no hosts here, your <em>eastwest</em> gateway is most likely not working correctly.</p>
<h3 id="workload-group-ca_addr"><a href="#workload-group-ca_addr" class="anchor-link">§</a>workload group ca_addr</h3>
<p>The <em>CA_ADDR</em> environment variable exported in the <em>cluster.env</em> file points by default to the Istio TLS port, the <em>15012</em>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.workload.sh --no-fix-ca
</span></span><span class="line"><span class="cl">cat .data/workload-files/cluster.env <span class="p">|</span> grep CA_ADDR
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>CA_ADDR=&#39;istiod-1-19-3.istio-system.svc:15012&#39;
</code></pre><p>The service name is correct but the port isn&rsquo;t. I hoped that the tool would pick up the port from the ingress gateway service but the help for <em>istioctl x workload entry configure</em> says:</p>
<pre tabindex="0"><code>      --ingressService string   Name of the Service to be used as the ingress gateway,
                                in the format &lt;service&gt;.&lt;namespace&gt;. If no namespace
                                is provided, the default istio-system namespace will
                                be used. (default &#34;istio-eastwestgateway&#34;)
</code></pre><p>Since that&rsquo;s our gateway name, it obviously doesn&rsquo;t detect ports. By default <em>install.workload.sh</em> program fixes that by simply appending the <em>CA_ADDR</em> to use to the end of the <em>cluster.env</em> file.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat .data/workload-files/cluster.env <span class="p">|</span> grep CA_ADDR
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>CA_ADDR=&#39;istiod-1-19-3.istio-system.svc:15012&#39;
CA_ADDR=istiod-&#39;1-19-3.istio-system.svc:15013&#39;
</code></pre><h2 id="the-vm-arm64-bootstrap-caveat"><a href="#the-vm-arm64-bootstrap-caveat" class="anchor-link">§</a>the vm: <code>arm64</code> bootstrap caveat</h2>
<p>For example if you are on an M2 mac, like me&hellip; Istio documentation instructs to install Istio sidecar on the VM using a downloaded <em>deb</em> package. The problem is, <em>Multipass</em> runs an <em>arm64</em> build of Ubuntu and the <em>deb</em> package is available only for the <em>amd64</em> architecture. Eventually, trying to start Istio on the VM, you&rsquo;d end up with:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo dpkg -i istio-sidecar.deb
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>dpkg: error processing archive istio-sidecar.deb (--install):
 package architecture (amd64) does not match system (arm64)
Errors were encountered while processing:
 istio-sidecar.deb
</code></pre><p>As a workaround, I have to replicate the work done in the <em>deb</em> package but I have to source <em>arm64</em> binaries.</p>
<h3 id="the-deb-package"><a href="#the-deb-package" class="anchor-link">§</a>the <em>deb</em> package</h3>
<p>I decompressed it:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">source</span> run.env
</span></span><span class="line"><span class="cl">wget <span class="s2">&#34;https://storage.googleapis.com/istio-release/releases/</span><span class="si">${</span><span class="nv">ISTIO_VERSION</span><span class="si">}</span><span class="s2">/deb/istio-sidecar.deb&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -O <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">/istio-sidecar/istio-sidecar.deb&#34;</span>
</span></span><span class="line"><span class="cl">tar xf <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">/istio-sidecar/istio-sidecar.deb&#34;</span> -C <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">/istio-sidecar/&#34;</span>
</span></span><span class="line"><span class="cl">tar xf <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">/istio-sidecar/data.tar.gz&#34;</span> -C <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span><span class="s2">/istio-sidecar/&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>and kept the following:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git ls-tree -r HEAD <span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>/istio-sidecar
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>100644 blob c18ec3ce73f52fafe05585de91cd4cda2cdf3951	.data/istio-sidecar/lib/systemd/system/istio.service
100755 blob e022fbb08d4375a66276263b70380230e4702dbe	.data/istio-sidecar/usr/local/bin/istio-start.sh
100644 blob ab4bbffd39a7462db68312b7049828c7b4c1d673	.data/istio-sidecar/var/lib/istio/envoy/envoy_bootstrap_tmpl.json
100644 blob fc42e5483094378ca0f0b00cd52f81d1827531cb	.data/istio-sidecar/var/lib/istio/envoy/sidecar.env
</code></pre><h3 id="arm64-binaries"><a href="#arm64-binaries" class="anchor-link">§</a><code>arm64</code> binaries</h3>
<p><strong>Skip if not on an <em>arm64</em> host</strong>.</p>
<p>Two binaries have to be replaced with their <em>arm64</em> versions:</p>
<ul>
<li><code>/usr/local/bin/envoy</code></li>
<li><code>/usr/local/bin/pilot-agent</code></li>
</ul>
<p>For me, the easiest way I could come up with was to:</p>
<ul>
<li>Download the <em>linux/arm64</em> Istio <em>proxyv2</em> Docker image.</li>
<li>Create a container, don&rsquo;t start it.</li>
<li>Copy the files out of the file system.</li>
<li>Remove the container.</li>
<li>Reference exported filesystem for required <em>arm64</em> binaries.</li>
</ul>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.arm64.binary.patches.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The default <em>CONTAINER_TOOL</em> depends on your <em>run.env</em> and equals to <em>docker</em> when not set. To use <em>podman</em>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">CONTAINER_TOOL</span><span class="o">=</span>podman ./install.arm64.binary.patches.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="bootstrap-the-vm"><a href="#bootstrap-the-vm" class="anchor-link">§</a>bootstrap the vm</h2>
<p>This program deploys all the files required by the VM to join the mesh, moves them to the right places, and configures to VM to handle the Istio sidecar.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.vm.bootstrap.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="validate-the-vm"><a href="#validate-the-vm" class="anchor-link">§</a>validate the vm</h2>
<p>Get the shell on the VM:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">multipass <span class="nb">exec</span> vm-istio-external-workload -- bash
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>On the VM <code>ubuntu@vm-istio-external-workload:~$</code>, regardless of the fact that we set the <em>CA_ADDR</em>, we still have to use the correct value for the <em>PILOT_ADDRESS</em>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> / <span class="o">&amp;&amp;</span> sudo <span class="nv">PILOT_ADDRESS</span><span class="o">=</span>istiod-1-19-3.istio-system.svc:15013 istio-start.sh
</span></span><span class="line"><span class="cl"><span class="c1"># cd / &amp;&amp; sudo PILOT_ADDRESS=istiod-${ISTIO_REVISION}.${ISTIO_NAMESPACE}.svc:${EWG_PORT_TLS_ISTIOD} istio-start.sh</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>However, this is also already dealt with in <em>install.workload.sh</em>. We can start the program with:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> / <span class="o">&amp;&amp;</span> sudo istio-start.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>2023-11-01T01:27:02.836001Z	info	Running command: iptables -t nat -D PREROUTING -p tcp -j ISTIO_INBOUND
2023-11-01T01:27:02.837879Z	info	Running command: iptables -t mangle -D PREROUTING -p tcp -j ISTIO_INBOUND
2023-11-01T01:27:02.839355Z	info	Running command: iptables -t nat -D OUTPUT -p tcp -j ISTIO_OUTPUT
...
2023-11-01T01:27:04.000569Z	error	citadelclient	Failed to load key pair open etc/certs/cert-chain.pem: no such file or directory
2023-11-01T01:27:04.004712Z	info	cache	generated new workload certificate	latency=118.57166ms ttl=23h59m58.995289161s
2023-11-01T01:27:04.004744Z	info	cache	Root cert has changed, start rotating root cert
2023-11-01T01:27:04.004759Z	info	ads	XDS: Incremental Pushing ConnectedEndpoints:2 Version:
2023-11-01T01:27:04.004885Z	info	cache	returned workload certificate from cache	ttl=23h59m58.995116686s
2023-11-01T01:27:04.004954Z	info	cache	returned workload trust anchor from cache	ttl=23h59m58.995045987s
2023-11-01T01:27:04.005150Z	info	cache	returned workload trust anchor from cache	ttl=23h59m58.994850182s
2023-11-01T01:27:04.006124Z	info	ads	SDS: PUSH request for node:vm-istio-external-workload.vmns resources:1 size:4.0kB resource:default
2023-11-01T01:27:04.006176Z	info	ads	SDS: PUSH request for node:vm-istio-external-workload.vmns resources:1 size:1.1kB resource:ROOTCA
2023-11-01T01:27:04.006204Z	info	cache	returned workload trust anchor from cache	ttl=23h59m58.99379629s
</code></pre><p><strong>If your istio-start.sh command doesn&rsquo;t produce any output</strong> after iptables output:</p>
<pre tabindex="0"><code>-A OUTPUT -p udp --dport 53 -d 127.0.0.53/32 -j REDIRECT --to-port 15053
COMMIT
2023-11-09T11:21:47.136622Z	info	Running command: iptables-restore --noflush
(hangs here)
</code></pre><p><code>CTRL+C</code>, exec to the VM, and rerun last command again.</p>
<h3 id="validate-dns-resolution"><a href="#validate-dns-resolution" class="anchor-link">§</a>validate DNS resolution</h3>
<p>Open another terminal:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">multipass <span class="nb">exec</span> vm-istio-external-workload -- bash
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>On the VM <code>ubuntu@vm-istio-external-workload:~$</code>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">dig istiod-1-19-3.istio-system.svc
</span></span><span class="line"><span class="cl"><span class="c1"># dig istiod-${ISTIO_REVISION}.${ISTIO_NAMESPACE}.svc</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>; &lt;&lt;&gt;&gt; DiG 9.18.12-0ubuntu0.22.04.3-Ubuntu &lt;&lt;&gt;&gt; istiod-1-19-3.istio-system.svc
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27953
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; WARNING: recursion requested but not available

;; QUESTION SECTION:
;istiod-1-19-3.istio-system.svc.	IN	A

;; ANSWER SECTION:
istiod-1-19-3.istio-system.svc. 30	IN	A	10.43.26.124

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Nov 01 02:31:59 CET 2023
;; MSG SIZE  rcvd: 80
</code></pre><p>The IP address should in the <em>answer section</em> be equal to the cluster IP of the service:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get service <span class="s2">&#34;istiod-</span><span class="si">${</span><span class="nv">ISTIO_REVISION</span><span class="si">}</span><span class="s2">&#34;</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ISTIO_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                                 AGE
istiod-1-19-3   ClusterIP   10.43.26.124   &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP   19m
</code></pre><p>It&rsquo;s <em>10.43.26.124</em> in both cases, the DNS resolution is working.</p>
<h3 id="validating-communication"><a href="#validating-communication" class="anchor-link">§</a>validating communication</h3>
<p>Deploy a sample application allowing us to validate the connection from the VM to the mesh.</p>
<h4 id="create-and-configure-the-namespace"><a href="#create-and-configure-the-namespace" class="anchor-link">§</a>create and configure the namespace</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create namespace sample
</span></span><span class="line"><span class="cl">kubectl label namespace sample <span class="s2">&#34;istio.io/rev=</span><span class="si">${</span><span class="nv">ISTIO_REVISION</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h5 id="on-amd64-host"><a href="#on-amd64-host" class="anchor-link">§</a>on <code>amd64</code> host</h5>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -n sample -f https://raw.githubusercontent.com/istio/istio/release-1.19/samples/helloworld/helloworld.yaml
</span></span></code></pre></td></tr></table></div>
</div>
</div><h5 id="on-arm64-host"><a href="#on-arm64-host" class="anchor-link">§</a>on <code>arm64</code> host</h5>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl --silent https://raw.githubusercontent.com/istio/istio/release-1.19/samples/helloworld/helloworld.yaml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="p">|</span> sed -E <span class="s1">&#39;s!istio/examples!radekg/examples!g&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="p">|</span> kubectl apply -n sample -f -
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Again, both example images published by Istio do not exist for the <em>linux/arm64</em> architecture, I build them from my own <em>Dockerfile</em> for <em>linux/arm64</em>. <a href="https://github.com/radekg/istio-vms/tree/mainistio-examples" target="_blank" rel="noopener">The source code is here</a><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">[4]</a></sup>.</p>
<h4 id="hello-world-pods-are-running"><a href="#hello-world-pods-are-running" class="anchor-link">§</a>hello world pods are running</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pods -n sample -w
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>NAME                            READY   STATUS            RESTARTS   AGE
helloworld-v1-cff64bf8c-z5nq5   0/2     PodInitializing   0          8s
helloworld-v2-9fdc9f56f-tbmk8   0/2     PodInitializing   0          8s
helloworld-v1-cff64bf8c-z5nq5   1/2     Running           0          20s
helloworld-v2-9fdc9f56f-tbmk8   1/2     Running           0          21s
helloworld-v1-cff64bf8c-z5nq5   2/2     Running           0          21s
helloworld-v2-9fdc9f56f-tbmk8   2/2     Running           0          22s
</code></pre><h4 id="checking-vm-to-mesh-connectivity"><a href="#checking-vm-to-mesh-connectivity" class="anchor-link">§</a>checking vm to mesh connectivity</h4>
<p>In a shell on a VM <code>ubuntu@vm-istio-external-workload:-$</code>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -v helloworld.sample.svc:5000/hello
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>*   Trying 10.43.109.101:5000...
* Connected to helloworld.sample.svc (10.43.109.101) port 5000 (#0)
&gt; GET /hello HTTP/1.1
&gt; Host: helloworld.sample.svc:5000
&gt; User-Agent: curl/7.81.0
&gt; Accept: */*
&gt;
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; server: envoy
&lt; date: Wed, 01 Nov 2023 01:59:55 GMT
&lt; content-type: text/html; charset=utf-8
&lt; content-length: 59
&lt; x-envoy-upstream-service-time: 88
&lt;
Hello version: v2, instance: helloworld-v2-9fdc9f56f-tbmk8
* Connection #0 to host helloworld.sample.svc left intact
</code></pre><p>The service responded, the VM can reach services in the mesh.</p>
<h2 id="routing-mesh-traffic-to-the-vm"><a href="#routing-mesh-traffic-to-the-vm" class="anchor-link">§</a>routing mesh traffic to the vm</h2>
<p>Create a service pointing at the workload group. This sets up the route to the VM service for a port. The example uses hardcoded values but it would be a simple job to makes those configurable.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.route.to.vm.sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Find the workload entry, this exists only when Istio sidecar is running in the VM.</p>
<h3 id="workload-entry-is-unhealthy"><a href="#workload-entry-is-unhealthy" class="anchor-link">§</a>workload entry is unhealthy</h3>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get workloadentry -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">VM_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>NAME                                    AGE     ADDRESS
external-app-192.168.64.64-vm-network   2m33s   192.168.64.64
</code></pre><p>Check its status, it will be unhealthy:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get workloadentry external-app-192.168.64.64-vm-network -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">VM_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span> -o yaml <span class="p">|</span> yq <span class="s1">&#39;.status&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastProbeTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-11-01T21:04:50.343243250Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-11-01T21:04:50.343245959Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Get &#34;http://localhost:8000/&#34;: dial tcp 127.0.0.6:0-&gt;127.0.0.1:8000: connect: connection refused&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;False&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Healthy</span><span class="w">
</span></span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="fix-it-by-starting-the-workload"><a href="#fix-it-by-starting-the-workload" class="anchor-link">§</a>fix it by starting the workload</h3>
<p>The reason why it is unhealthy is because the service on the VM isn&rsquo;t running. Start a simple HTTP server to fix this, on the VM <code>ubuntu@vm-istio-external-workload:-$</code>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">python3 -m http.server
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
127.0.0.6 - - [01/Nov/2023 22:44:25] &#34;GET / HTTP/1.1&#34; 200 -
127.0.0.6 - - [01/Nov/2023 22:44:30] &#34;GET / HTTP/1.1&#34; 200 -
127.0.0.6 - - [01/Nov/2023 22:44:35] &#34;GET / HTTP/1.1&#34; 200 -
...
</code></pre><p>Almost immediately we see requests arriving. This is the health check. Istio sidecar on the VM logged:</p>
<pre tabindex="0"><code>2023-11-01T21:04:50.337302Z	info	healthcheck	failure threshold hit, marking as unhealthy: Get &#34;http://localhost:8000/&#34;: dial tcp 127.0.0.6:0-&gt;127.0.0.1:8000: connect: connection refused
2023-11-01T21:32:12.943221Z	info	xdsproxy	connected to upstream XDS server: istiod-1-19-3.istio-system.svc:15012
2023-11-01T21:44:25.343463Z	info	healthcheck	success threshold hit, marking as healthy
</code></pre><p>The status of the workload entry has changed:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get workloadentry external-app-192.168.64.64-vm-network -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">VM_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span> -o yaml <span class="p">|</span> yq <span class="s1">&#39;.status&#39;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastProbeTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-11-01T21:44:25.339260737Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-11-01T21:44:25.339264070Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Healthy</span><span class="w">
</span></span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="verify-connectivity-with-curl"><a href="#verify-connectivity-with-curl" class="anchor-link">§</a>verify connectivity with <code>curl</code></h3>
<p>Finally, run an actual command to verify:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl run vm-response-test -n sample --image<span class="o">=</span>curlimages/curl:8.4.0 --rm -i --tty -- sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>If you don&#39;t see a command prompt, try pressing enter.
~ $
</code></pre><p><strong>Pay attention</strong> to the <strong>namespace</strong> used in the last command above. The <em>curl</em> pod must be launched in an <em>Istio-enabled</em> namespace, and <em>sample</em> already existed.</p>
<p>Execute the following command in that terminal:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -v http://external-app.vmns.svc:8000/
</span></span><span class="line"><span class="cl"><span class="c1"># Use the VM_NAMESPACE from run.env</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>*   Trying 10.43.122.27:8000...
* Connected to external-app.vmns.svc (10.43.122.27) port 8000
&gt; GET / HTTP/1.1
&gt; Host: external-app.vmns.svc:8000
&gt; User-Agent: curl/8.4.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; server: envoy
&lt; date: Wed, 01 Nov 2023 22:10:20 GMT
&lt; content-type: text/html; charset=utf-8
&lt; content-length: 768
&lt; x-envoy-upstream-service-time: 7
&lt;
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34; &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34;&gt;
&lt;title&gt;Directory listing for /&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Directory listing for /&lt;/h1&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;.bash_history&#34;&gt;.bash_history&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.bash_logout&#34;&gt;.bash_logout&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.bashrc&#34;&gt;.bashrc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.cache/&#34;&gt;.cache/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.profile&#34;&gt;.profile&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.ssh/&#34;&gt;.ssh/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.sudo_as_admin_successful&#34;&gt;.sudo_as_admin_successful&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;lib/&#34;&gt;lib/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;usr/&#34;&gt;usr/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;var/&#34;&gt;var/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;workload/&#34;&gt;workload/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;/body&gt;
&lt;/html&gt;
* Connection #0 to host external-app.vmns.svc left intact
</code></pre><h2 id="enable-strict-tls"><a href="#enable-strict-tls" class="anchor-link">§</a>enable strict tls</h2>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f - <span class="s">&lt;&lt;EOP
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: security.istio.io/v1beta1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: PeerAuthentication
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: default
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: ${ISTIO_NAMESPACE}
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  mtls:
</span></span></span><span class="line"><span class="cl"><span class="s">    mode: STRICT
</span></span></span><span class="line"><span class="cl"><span class="s">EOP</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>There are no observable changes.</p>
<h2 id="network-policies"><a href="#network-policies" class="anchor-link">§</a>network policies</h2>
<h3 id="caveat-cannot-select-a-workload-entry-in-a-network-policy"><a href="#caveat-cannot-select-a-workload-entry-in-a-network-policy" class="anchor-link">§</a>caveat: cannot select a workload entry in a network policy</h3>
<p>Because a network policy selects pods using <code>.spec.podSelector</code>, and we have no pods—we have a workload entry instead—we are not able to attach network policies to the VM. The following has no effect:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f - <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">kind: NetworkPolicy
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: networking.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: deny-all
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: ${VM_NAMESPACE}
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  podSelector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">      app: external-app
</span></span></span><span class="line"><span class="cl"><span class="s">  ingress: []
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl run vm-response-test -n sample --image<span class="o">=</span>curlimages/curl:8.4.0 --rm -i --tty -- sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>in that shell:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -v http://external-app.vmns.svc:8000/
</span></span><span class="line"><span class="cl"><span class="c1"># Use the VM_NAMESPACE from run.env</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>*   Trying 10.43.122.27:8000...
* Connected to external-app.vmns.svc (10.43.122.27) port 8000
&gt; GET / HTTP/1.1
&gt; Host: external-app.vmns.svc:8000
&gt; User-Agent: curl/8.4.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; server: envoy
...
</code></pre><p><strong>Cosider future work</strong>: is this working when using Istio CNI?</p>
<h3 id="guarding-the-vm-from-the-source-of-traffic-namespace"><a href="#guarding-the-vm-from-the-source-of-traffic-namespace" class="anchor-link">§</a>guarding the vm from the source of traffic namespace</h3>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -n sample -f - <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">kind: NetworkPolicy
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: networking.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: deny-egress-tovm
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  podSelector: {}
</span></span></span><span class="line"><span class="cl"><span class="s">  policyTypes:
</span></span></span><span class="line"><span class="cl"><span class="s">  - Egress
</span></span></span><span class="line"><span class="cl"><span class="s">  egress:
</span></span></span><span class="line"><span class="cl"><span class="s">  - to:
</span></span></span><span class="line"><span class="cl"><span class="s">    - namespaceSelector:
</span></span></span><span class="line"><span class="cl"><span class="s">        matchExpressions:
</span></span></span><span class="line"><span class="cl"><span class="s">        - key: namespace
</span></span></span><span class="line"><span class="cl"><span class="s">          operator: NotIn
</span></span></span><span class="line"><span class="cl"><span class="s">          values: [&#34;${VM_NAMESPACE}&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl run vm-response-test -n sample --image<span class="o">=</span>curlimages/curl:8.4.0 --rm -i --tty -- sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>in that shell:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://external-app.vmns.svc:8000/
</span></span><span class="line"><span class="cl"><span class="c1"># Use the VM_NAMESPACE from run.env</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>upstream connect error or disconnect/reset before headers. retried and the latest reset reason: remote connection failure, transport failure reason: delayed connect error: 111~ $ ^C
~ $ exit
Session ended, resume using &#39;kubectl attach vm-response-test -c vm-response-test -i -t&#39; command when the pod is running
pod &#34;vm-response-test&#34; deleted
</code></pre><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl delete networkpolicy deny-egress-tovm -n sample
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl run vm-response-test -n sample --image<span class="o">=</span>curlimages/curl:8.4.0 --rm -i --tty -- sh
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>in that shell:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://external-app.vmns.svc:8000/
</span></span><span class="line"><span class="cl"><span class="c1"># Use the VM_NAMESPACE from run.env</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><pre tabindex="0"><code>&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34; &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34;&gt;
&lt;title&gt;Directory listing for /&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Directory listing for /&lt;/h1&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;.bash_history&#34;&gt;.bash_history&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.bash_logout&#34;&gt;.bash_logout&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.bashrc&#34;&gt;.bashrc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.cache/&#34;&gt;.cache/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.profile&#34;&gt;.profile&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.ssh/&#34;&gt;.ssh/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;.sudo_as_admin_successful&#34;&gt;.sudo_as_admin_successful&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;lib/&#34;&gt;lib/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;usr/&#34;&gt;usr/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;var/&#34;&gt;var/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;workload/&#34;&gt;workload/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h3 id="network-boundary-for-network-policies"><a href="#network-boundary-for-network-policies" class="anchor-link">§</a>network boundary for network policies</h3>
<p>Current situation:</p>
<ul>
<li>Egress from source to the VM can be blocked only on a namespace level.</li>
<li>On the VM side, network policies aren&rsquo;t capable selecting workload entries. These only select pods using <code>.spec.podSelector</code>.</li>
</ul>
<p>The natural network boundary is the namespace and explicit deny of egress to the namespace with the VM.</p>
<h2 id="cleaning-up"><a href="#cleaning-up" class="anchor-link">§</a>cleaning up</h2>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./install.k3s.sh --delete
</span></span><span class="line"><span class="cl">./install.vm.create.sh --delete
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ~
</span></span><span class="line"><span class="cl">rm -rf ~/.project
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="summary"><a href="#summary" class="anchor-link">§</a>summary</h2>
<p>Success, a pod in the mesh can communicate to the VM via the service, VM is in the mesh and can communicate back to the mesh. Istio VM workloads are easy way to automate VM-mesh onboarding.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://istio.io/latest/docs/setup/install/virtual-machine/" target="_blank" rel="noopener">Virtual Machine Installation</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://multipass.run/docs/installing-on-linux" target="_blank" rel="noopener">Installing Multipass on Linux</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/mikefarah/yq#install" target="_blank" rel="noopener">yq installation instructions</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:4">
<p><a href="https://github.com/radekg/istio-vms/tree/main/istio-examples" target="_blank" rel="noopener">Istio hello world examples for linux/arm64</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
</ol>
</div>

            </div>

            
    
    



        </article>

        

        


        


        <div class="post-share">

        

        <div class="share-items">

            
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=https://gruchalski.com/posts/2023-11-02-istio-external-workloads/&amp;text=Istio%20VM%20workloads&amp;hashtags=Istio,Kubernetes,K8s,Multipass,Tls,&amp;via=%25!s%28%3cnil%3e%29" title="Share on Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            

            
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://gruchalski.com/posts/2023-11-02-istio-external-workloads/&amp;title=Istio%20VM%20workloads&amp;summary=setting%20up%20a%20proof-of-concept%20connectivity%20with%20a%20VM%20in%20an%20Istio%20mesh&amp;source=gruchalski.com" title="Share on LinkedIn" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            

            

            

            

            

            
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="Share via QR Code"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/gruchalski.com\/posts\/2023-11-02-istio-external-workloads\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">See Also:<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/2023-07-09-istio-cert-manager-lets-encrypt-and-https-redirect/" class="related-link">Istio, cert-manager, Let&rsquo;s Encrypt and HTTPS redirect</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2023-07-10-yq-the-yaml-power-tool/" class="related-link">yq - the yaml power tool</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2025-11-04-the-leading-thought/" class="related-link">The leading thought</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2022-06-19-istio-canary-upgrades/" class="related-link">Istio canary upgrades</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2021-04-06-apache-mesos-reaches-end-of-life/" class="related-link">Apache Mesos reaches end of life</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/istio/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Istio</a>
                
            
                
                
                
                
                    
                    <a href="/tags/kubernetes/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Kubernetes</a>
                
            
                
                
                
                
                    
                    <a href="/tags/k8s/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>K8s</a>
                
            
                
                
                
                
                    
                    <a href="/tags/multipass/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Multipass</a>
                
            
                
                
                
                
                    
                    <a href="/tags/tls/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Tls</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/posts/2023-11-20-warning-istio-is-being-downgraded/" rel="prev">&lt; Warning: Istio is being downgraded</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/posts/2023-07-21-yugabytedb-build-infrastructure-upgrade/" rel="next">YugabyteDB build infrastructure upgrade &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;2015–2025&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://en.wikipedia.org/wiki/Canonical_link_element" target="_blank" rel="noopener">reposting requires attribution, <strong>use canonical links</strong> »</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:radek@gruchalski.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/radekg" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://linkedin.com/in/radgruchalski" target="_blank" rel="external noopener" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon social-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        

        








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
