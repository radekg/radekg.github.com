<!DOCTYPE html>
<html lang="en">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.104.3" /><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Multi-tenant Vault PKI with custom root PEM bundles | gruchalski.com</title>

    <link rel="stylesheet" href="/css/meme.min.2a066069a1d2940b3a3107397cddde65473ce8d29a2313ccc3989759c9372a79.css"/>

    
    
        <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js" defer></script><script src="/js/meme.min.1321582b41a9fdb1a15023a3d3204fa013ace575e4c594c9dbc43078a016fce0.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Amaranth&amp;display=swap" /></noscript>

    <meta name="author" content="Radek Gruchalski" /><meta name="description" content="Configuring multi-tenant Vault PKI with OpenSSL root and intermediate CAs" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="gruchalski.com" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="gruchalski.com" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    
        <link rel="canonical" href="https://gruchalski.com/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/" />
    

    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2020-09-09T00:00:00+00:00",
        "dateModified": "2020-09-09T23:10:15+02:00",
        "url": "https://gruchalski.com/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/",
        "headline": "Multi-tenant Vault PKI with custom root PEM bundles",
        "description": "Configuring multi-tenant Vault PKI with OpenSSL root and intermediate CAs",
        "inLanguage" : "en",
        "articleSection": "posts",
        "wordCount":  3787 ,
        "image": ["https://gruchalski.com/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/ca-chain.png","https://gruchalski.com/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/certificate.png","https://gruchalski.com/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/private-key.png"],
        "author": {
            "@type": "Person",
            "email": "radek@gruchalski.com",
            "image": "https://gruchalski.com/icons/apple-touch-icon.png",
            "url": "https://io-oi.me/",
            "name": "radek gruchalski"
        },
        "license": "[reposting requires attribution, **use canonical links** Â»](https://en.wikipedia.org/wiki/Canonical_link_element)",
        "publisher": {
            "@type": "Organization",
            "name": "gruchalski.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://gruchalski.com/icons/apple-touch-icon.png"
            },
            "url": "https://gruchalski.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://gruchalski.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />



    



<meta property="og:title" content="Multi-tenant Vault PKI with custom root PEM bundles" />
<meta property="og:description" content="Configuring multi-tenant Vault PKI with OpenSSL root and intermediate CAs" />
<meta property="og:url" content="https://gruchalski.com/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/" />
<meta property="og:site_name" content="gruchalski.com" />
<meta property="og:locale" content="en" /><meta property="og:image" content="https://gruchalski.com/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/ca-chain.png" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-09-09T00:00:00&#43;00:00" />
    <meta property="article:modified_time" content="2020-09-09T23:10:15&#43;02:00" />
    
    <meta property="article:section" content="posts" />


        <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />

        




    
    <script>
        var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
        var doNotTrack = (dnt == "1" || dnt == "yes");
        if (!doNotTrack) {
            window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
            if (window.sessionStorage) {
                var GA_SESSION_STORAGE_KEY = 'ga:clientId';
                ga('create', 'UA-39073034-1', {
                'storage': 'none',
                'clientId': sessionStorage.getItem(GA_SESSION_STORAGE_KEY)
               });
               ga(function(tracker) {
                sessionStorage.setItem(GA_SESSION_STORAGE_KEY, tracker.get('clientId'));
               });
           }
            ga('set', 'anonymizeIp', true);
            ga('send', 'pageview');
        }
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    


    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">gruchalski.com</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">posts</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="icon code-branch"><path d="M384 144c0-44.2-35.8-80-80-80s-80 35.8-80 80c0 36.4 24.3 67.1 57.5 76.8-.6 16.1-4.2 28.5-11 36.9-15.4 19.2-49.3 22.4-85.2 25.7-28.2 2.6-57.4 5.4-81.3 16.9v-144c32.5-10.2 56-40.5 56-76.3 0-44.2-35.8-80-80-80S0 35.8 0 80c0 35.8 23.5 66.1 56 76.3v199.3C23.5 365.9 0 396.2 0 432c0 44.2 35.8 80 80 80s80-35.8 80-80c0-34-21.2-63.1-51.2-74.6 3.1-5.2 7.8-9.8 14.9-13.4 16.2-8.2 40.4-10.4 66.1-12.8 42.2-3.9 90-8.4 118.2-43.4 14-17.4 21.1-39.8 21.6-67.9 31.6-10.8 54.4-40.7 54.4-75.9zM80 64c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm0 384c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16zm224-320c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16z"/></svg><span class="menu-item-name">categories</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">tags</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">about</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/privacy/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" class="icon info"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"/></svg><span class="menu-item-name">privacy</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href=""></a>
                </li>
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="default" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">Multi-tenant Vault PKI with custom root PEM bundles</h1>

            

            
                <div class="post-description p-summary">Configuring multi-tenant Vault PKI with OpenSSL root and intermediate CAs</div>
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2020-09-09T00:00:00&#43;00:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;September 9, 2020</time>
    
    
    
    
        
        
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;3787</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;18&nbsp;mins</span>
    
    
    
</div>

            

            

            <div class="post-body e-content">
              <p>In the previous article<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">[1]</a></sup>, I have investigated modern PKI software alternatives. One of the options on the list was HashiCorp Vault. The natural next step is to set up a Vault PKI.</p>
<p>This article documents setting up an imaginary multi-tenant Vault PKI with custom PEM bundles generated with OpenSSL. The steps the following:</p>
<ul>
<li>create a root CA with OpenSSL</li>
<li>create intermediate CAs for imaginary clients with OpenSSL</li>
<li>using HashiCorp Vault in development mode:
<ul>
<li>import custom bundle with root and intermediate certificates</li>
<li>configure Vault roles</li>
<li>issue a certificate</li>
</ul>
</li>
</ul>
<p>The method for generating the root and intermediate CAs comes from <a href="https://jamielinux.com/docs/openssl-certificate-authority/" target="_blank" rel="noopener">OpenSSL Certificate Authority</a> guide written by <a href="https://jamielinux.com/" target="_blank" rel="noopener">Jamie Nguyen</a><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">[2]</a></sup>. I&rsquo;m including the scripts and the configuration in this article for reference.</p>
<h2 id="the-result"><a href="#the-result" class="anchor-link">Â§</a>The result</h2>
<p>As an outcome of this article, the reader will be able to create a new root CA and add new intermediate CAs to existing root CAs with a single command. This command will also prepare theÂ Vault PEM bundle. With the Vault bundle and four more shell commands, the user will have aÂ ready to use certificate with a CA chain. The process will be:</p>
<ol>
<li>run <code>init-intermediate.sh &lt;ca-name&gt; &lt;client-id&gt;</code> to have an intermediate CA</li>
<li>enable PKI for the new client with <code>vault</code> shell command</li>
<li>import a PEM bundle with <code>vault</code> shell command</li>
<li>add a permission with <code>vault</code> shell command</li>
<li>issue a certificate with <code>vault</code> shell command</li>
</ol>
<h2 id="create-a-root-ca"><a href="#create-a-root-ca" class="anchor-link">Â§</a>Create a root CA</h2>
<p>I&rsquo;m going to start by creating an environment file which will contain a location for the CA and distinguished name settings. As the root of the CA, I&rsquo;m going to use <code>~/.ca</code> directory.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir -p ~/.ca
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Now, I will create the environment file, <code>~/.ca/.article-ca</code>:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">tee ~/.ca/.article-ca &gt;/dev/null <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s"># DN defaults:
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_COUNTRY_CODE=DE
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_STATE_OR_PROVINCE=&#34;NRW&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_LOCALITY=&#34;Herzogenrath&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_ORG=&#34;klarrio.com&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_ORG_UNIT=gmbh
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_EMAIL_ADDRESS=&#34;radek.gruchalski@klarrio.com&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">export CA_DN_DEFAULT_COMMON_NAME=&#34;${CA_DN_DEFAULT_ORG_UNIT}.${CA_DN_DEFAULT_ORG}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s"># Certificate settings:
</span></span></span><span class="line"><span class="cl"><span class="s">export DEFAULT_BITS=2048
</span></span></span><span class="line"><span class="cl"><span class="s">export DEFAULT_CA_DAYS=365
</span></span></span><span class="line"><span class="cl"><span class="s">export DEFAULT_DAYS=90
</span></span></span><span class="line"><span class="cl"><span class="s">export NS_CLIENT_CERT_COMMENT=&#34;OpenSSL Generated Server Certificate&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">export NS_SERVER_CERT_COMMENT=&#34;OpenSSL Generated Server Certificate&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>The next step is to create a shell program responsible for writing the CA root configuration. This, and the following intermediate, are by far the two longest bits of code in this article.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -eu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CA_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/.<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/.<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/.<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span> not found
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CADIR</span><span class="o">=</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># init subdirectories, index.txt and serial files:</span>
</span></span><span class="line"><span class="cl">mkdir certs crl newcerts private
</span></span><span class="line"><span class="cl">chmod <span class="m">700</span> private
</span></span><span class="line"><span class="cl">touch index.txt
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1000</span> &gt; serial
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># write the root CA config:</span>
</span></span><span class="line"><span class="cl">tee openssl.cnf &gt;/dev/null <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s"># OpenSSL root CA configuration file.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ ca ]
</span></span></span><span class="line"><span class="cl"><span class="s"># man ca
</span></span></span><span class="line"><span class="cl"><span class="s">default_ca = CA_default
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ CA_default ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Directory and file locations.
</span></span></span><span class="line"><span class="cl"><span class="s">dir               = ${CADIR}
</span></span></span><span class="line"><span class="cl"><span class="s">certs             = \$dir/certs
</span></span></span><span class="line"><span class="cl"><span class="s">crl_dir           = \$dir/crl
</span></span></span><span class="line"><span class="cl"><span class="s">new_certs_dir     = \$dir/newcerts
</span></span></span><span class="line"><span class="cl"><span class="s">database          = \$dir/index.txt
</span></span></span><span class="line"><span class="cl"><span class="s">serial            = \$dir/serial
</span></span></span><span class="line"><span class="cl"><span class="s">RANDFILE          = \$dir/private/.rand
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># The root key and root certificate.
</span></span></span><span class="line"><span class="cl"><span class="s">private_key       = \$dir/private/ca.key.pem
</span></span></span><span class="line"><span class="cl"><span class="s">certificate       = \$dir/certs/ca.cert.pem
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># For certificate revocation lists.
</span></span></span><span class="line"><span class="cl"><span class="s">crlnumber         = \$dir/crlnumber
</span></span></span><span class="line"><span class="cl"><span class="s">crl               = \$dir/crl/ca.crl.pem
</span></span></span><span class="line"><span class="cl"><span class="s">crl_extensions    = crl_ext
</span></span></span><span class="line"><span class="cl"><span class="s">default_crl_days  = 30
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span class="line"><span class="cl"><span class="s">default_md        = sha256
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">name_opt          = ca_default
</span></span></span><span class="line"><span class="cl"><span class="s">cert_opt          = ca_default
</span></span></span><span class="line"><span class="cl"><span class="s">default_days      = ${DEFAULT_DAYS}
</span></span></span><span class="line"><span class="cl"><span class="s">preserve          = no
</span></span></span><span class="line"><span class="cl"><span class="s">policy            = policy_strict
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ policy_strict ]
</span></span></span><span class="line"><span class="cl"><span class="s"># The root CA should only sign intermediate certificates that match.
</span></span></span><span class="line"><span class="cl"><span class="s"># See the POLICY FORMAT section of &#39;man ca&#39;.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName             = match
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName     = match
</span></span></span><span class="line"><span class="cl"><span class="s">organizationName        = match
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName  = optional
</span></span></span><span class="line"><span class="cl"><span class="s">commonName              = supplied
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress            = optional
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ policy_loose ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Allow the intermediate CA to sign a more diverse range of certificates.
</span></span></span><span class="line"><span class="cl"><span class="s"># See the POLICY FORMAT section of the &#39;ca&#39; man page.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName             = optional
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName     = optional
</span></span></span><span class="line"><span class="cl"><span class="s">localityName            = optional
</span></span></span><span class="line"><span class="cl"><span class="s">organizationName        = optional
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName  = optional
</span></span></span><span class="line"><span class="cl"><span class="s">commonName              = supplied
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress            = optional
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ req ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Options for the &#39;req&#39; tool (&#39;man req&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">default_bits        = ${DEFAULT_BITS}
</span></span></span><span class="line"><span class="cl"><span class="s">distinguished_name  = req_distinguished_name
</span></span></span><span class="line"><span class="cl"><span class="s">string_mask         = utf8only
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span class="line"><span class="cl"><span class="s">default_md          = sha256
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Extension to add when the -x509 option is used.
</span></span></span><span class="line"><span class="cl"><span class="s">x509_extensions     = v3_ca
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ req_distinguished_name ]
</span></span></span><span class="line"><span class="cl"><span class="s"># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName                     = Country Name (2 letter code)
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName             = State or Province Name
</span></span></span><span class="line"><span class="cl"><span class="s">localityName                    = Locality Name
</span></span></span><span class="line"><span class="cl"><span class="s">0.organizationName              = Organization Name
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName          = Organizational Unit Name
</span></span></span><span class="line"><span class="cl"><span class="s">commonName                      = Common Name
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress                    = Email Address
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Optionally, specify some defaults.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName_default             = ${CA_DN_DEFAULT_COUNTRY_CODE}
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName_default     = &#34;${CA_DN_DEFAULT_STATE_OR_PROVINCE}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">localityName_default            = &#34;${CA_DN_DEFAULT_LOCALITY}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">0.organizationName_default      = &#34;${CA_DN_DEFAULT_ORG}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName_default  = &#34;${CA_DN_DEFAULT_ORG_UNIT}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress_default            = &#34;${CA_DN_DEFAULT_EMAIL_ADDRESS}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ v3_ca ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for a typical CA (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid:always,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = critical, CA:true
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature, cRLSign, keyCertSign
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ v3_intermediate_ca ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for a typical intermediate CA (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid:always,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = critical, CA:true, pathlen:0
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature, cRLSign, keyCertSign
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ usr_cert ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for client certificates (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">nsCertType = client, email
</span></span></span><span class="line"><span class="cl"><span class="s">nsComment = &#34;${NS_CLIENT_CERT_COMMENT}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = clientAuth, emailProtection
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ server_cert ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for server certificates (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">nsCertType = server
</span></span></span><span class="line"><span class="cl"><span class="s">nsComment = &#34;${NS_SERVER_CERT_COMMENT}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid,issuer:always
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature, keyEncipherment
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = serverAuth
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ crl_ext ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extension for CRLs (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier=keyid:always
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ ocsp ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extension for OCSP signing certificates (&#39;man ocsp&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = critical, OCSPSignings
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generate root CA:</span>
</span></span><span class="line"><span class="cl">openssl genrsa -aes256 -out <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/private/ca.key.pem <span class="m">4096</span>
</span></span><span class="line"><span class="cl">chmod <span class="m">400</span> <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/private/ca.key.pem
</span></span><span class="line"><span class="cl">openssl req -config <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/openssl.cnf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      -key <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/private/ca.key.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      -new -x509 -days <span class="si">${</span><span class="nv">DEFAULT_CA_DAYS</span><span class="si">}</span> -sha256 -extensions v3_ca <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      -out <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/certs/ca.cert.pem
</span></span><span class="line"><span class="cl">chmod <span class="m">444</span> <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/certs/ca.cert.pem
</span></span><span class="line"><span class="cl">openssl x509 -noout -text -in <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/certs/ca.cert.pem
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>After saving the program as <code>~/.ca/init-ca.sh</code>, making it executable with <code>chmod +x ~/.ca/init-ca.sh</code> and running as <code>~/.ca/init-ca.sh article-ca</code>, the new CA has been created in <code>~/.ca/article-ca</code>. Using this method and changing the CA name given to the program asÂ theÂ first argument, more root CAs can be created.</p>
<p>The program will ask three times for the CA private key passphrase: to create the key, to verify and to use the key. Next, it will ask to confirm default values for the distinguished name. When all values are confirmed and correct, the CA root certificate will be generated.</p>
<p>The output will be similar to:</p>
<pre tabindex="0"><code>Generating RSA private key, 4096 bit long modulus
..........................++
...........................................................................................................................................................................................++
e is 65537 (0x10001)
Enter pass phrase for /Users/rad/.ca/article-ca/private/ca.key.pem:
Verifying - Enter pass phrase for /Users/rad/.ca/article-ca/private/ca.key.pem:
Enter pass phrase for /Users/rad/.ca/article-ca/private/ca.key.pem:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [DE]:
State or Province Name [NRW]:
Locality Name [Herzogenrath]:
Organization Name [klarrio.com]:
Organizational Unit Name [gmbh]:
Common Name []:
Email Address [radek.gruchalski@klarrio.com]:
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 14292483172117400839 (0xc65919b8604e4d07)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=DE, ST=NRW, L=Herzogenrath, O=klarrio.com, OU=gmbh/emailAddress=radek.gruchalski@klarrio.com
        Validity
            Not Before: Sep  8 20:53:48 2020 GMT
            Not After : Sep  8 20:53:48 2021 GMT
        Subject: C=DE, ST=NRW, L=Herzogenrath, O=klarrio.com, OU=gmbh/emailAddress=radek.gruchalski@klarrio.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:ab:bf:02:ef:72:b3:ce:ac:4b:37:01:1b:57:fc:
                    ...
                    0d:84:73:28:32:e8:f1:99:64:ee:f5:b2:6f:21:7f:
                    9e:08:21
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                06:DE:59:CD:9A:21:9F:A0:B2:32:EE:B3:E6:89:11:10:9C:6E:83:0F
            X509v3 Authority Key Identifier:
                keyid:06:DE:59:CD:9A:21:9F:A0:B2:32:EE:B3:E6:89:11:10:9C:6E:83:0F

            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Key Usage: critical
                Digital Signature, Certificate Sign, CRL Sign
    Signature Algorithm: sha256WithRSAEncryption
         35:30:29:2c:39:1b:57:81:d8:95:9a:26:1f:5c:44:62:65:ca:
         ...
         fe:28:53:b1:76:63:22:cd
</code></pre><p>on disk, there should be:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ tree ~/.ca/article-ca/
</span></span><span class="line"><span class="cl">/Users/rad/.ca/article-ca/
</span></span><span class="line"><span class="cl">âââ certs
</span></span><span class="line"><span class="cl">âÂ Â  âââ ca.cert.pem
</span></span><span class="line"><span class="cl">âââ crl
</span></span><span class="line"><span class="cl">âââ index.txt
</span></span><span class="line"><span class="cl">âââ newcerts
</span></span><span class="line"><span class="cl">âââ openssl.cnf
</span></span><span class="line"><span class="cl">âââ private
</span></span><span class="line"><span class="cl">âÂ Â  âââ ca.key.pem
</span></span><span class="line"><span class="cl">âââ serial
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">4</span> directories, <span class="m">5</span> files
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="create-an-intermediate-ca"><a href="#create-an-intermediate-ca" class="anchor-link">Â§</a>Create an intermediate CA</h2>
<p>The intermediate CA reuses the environment file of the root CA. The program to create it is very similar to the <code>init-ca.sh</code>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -eu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CA_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">INTERMEDIATE_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/.<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">source</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/.<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/.<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span> not found
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CADIR</span><span class="o">=</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/<span class="si">${</span><span class="nv">CA_NAME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">INTERMEDIATEDIR</span><span class="o">=</span><span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/intermediate/<span class="si">${</span><span class="nv">INTERMEDIATE_NAME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># init subdirectories, index.txt and serial files:</span>
</span></span><span class="line"><span class="cl">mkdir certs chain crl csr newcerts private vault-bundle
</span></span><span class="line"><span class="cl">chmod <span class="m">700</span> private
</span></span><span class="line"><span class="cl">touch index.txt
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1000</span> &gt; serial
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1000</span> &gt; crlnumber
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># write the intermediate config:</span>
</span></span><span class="line"><span class="cl">tee openssl.cnf &gt;/dev/null <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s"># OpenSSL intermediate CA configuration file.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ ca ]
</span></span></span><span class="line"><span class="cl"><span class="s"># &#39;man ca&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">default_ca = CA_default
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ CA_default ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Directory and file locations.
</span></span></span><span class="line"><span class="cl"><span class="s">dir               = ${INTERMEDIATEDIR}
</span></span></span><span class="line"><span class="cl"><span class="s">certs             = \$dir/certs
</span></span></span><span class="line"><span class="cl"><span class="s">crl_dir           = \$dir/crl
</span></span></span><span class="line"><span class="cl"><span class="s">new_certs_dir     = \$dir/newcerts
</span></span></span><span class="line"><span class="cl"><span class="s">database          = \$dir/index.txt
</span></span></span><span class="line"><span class="cl"><span class="s">serial            = \$dir/serial
</span></span></span><span class="line"><span class="cl"><span class="s">RANDFILE          = \$dir/private/.rand
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># The root key and root certificate.
</span></span></span><span class="line"><span class="cl"><span class="s">private_key       = \$dir/private/intermediate.key.pem
</span></span></span><span class="line"><span class="cl"><span class="s">certificate       = \$dir/certs/intermediate.cert.pem
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># For certificate revocation lists.
</span></span></span><span class="line"><span class="cl"><span class="s">crlnumber         = \$dir/crlnumber
</span></span></span><span class="line"><span class="cl"><span class="s">crl               = \$dir/crl/intermediate.crl.pem
</span></span></span><span class="line"><span class="cl"><span class="s">crl_extensions    = crl_ext
</span></span></span><span class="line"><span class="cl"><span class="s">default_crl_days  = 30
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span class="line"><span class="cl"><span class="s">default_md        = sha256
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">name_opt          = ca_default
</span></span></span><span class="line"><span class="cl"><span class="s">cert_opt          = ca_default
</span></span></span><span class="line"><span class="cl"><span class="s">default_days      = ${DEFAULT_DAYS}
</span></span></span><span class="line"><span class="cl"><span class="s">preserve          = no
</span></span></span><span class="line"><span class="cl"><span class="s">policy            = policy_loose
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ policy_strict ]
</span></span></span><span class="line"><span class="cl"><span class="s"># The root CA should only sign intermediate certificates that match.
</span></span></span><span class="line"><span class="cl"><span class="s"># See the POLICY FORMAT section of &#39;man ca&#39;.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName             = match
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName     = match
</span></span></span><span class="line"><span class="cl"><span class="s">organizationName        = match
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName  = optional
</span></span></span><span class="line"><span class="cl"><span class="s">commonName              = supplied
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress            = optional
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ policy_loose ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Allow the intermediate CA to sign a more diverse range of certificates.
</span></span></span><span class="line"><span class="cl"><span class="s"># See the POLICY FORMAT section of the &#39;ca&#39; man page.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName             = optional
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName     = optional
</span></span></span><span class="line"><span class="cl"><span class="s">localityName            = optional
</span></span></span><span class="line"><span class="cl"><span class="s">organizationName        = optional
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName  = optional
</span></span></span><span class="line"><span class="cl"><span class="s">commonName              = supplied
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress            = optional
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ req ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Options for the &#39;req&#39; tool (&#39;man req&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">default_bits        = ${DEFAULT_BITS}
</span></span></span><span class="line"><span class="cl"><span class="s">distinguished_name  = req_distinguished_name
</span></span></span><span class="line"><span class="cl"><span class="s">string_mask         = utf8only
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span class="line"><span class="cl"><span class="s">default_md          = sha256
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Extension to add when the -x509 option is used.
</span></span></span><span class="line"><span class="cl"><span class="s">x509_extensions     = v3_ca
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ req_distinguished_name ]
</span></span></span><span class="line"><span class="cl"><span class="s"># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName                     = Country Name (2 letter code)
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName             = State or Province Name
</span></span></span><span class="line"><span class="cl"><span class="s">localityName                    = Locality Name
</span></span></span><span class="line"><span class="cl"><span class="s">0.organizationName              = Organization Name
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName          = Organizational Unit Name
</span></span></span><span class="line"><span class="cl"><span class="s">commonName                      = Common Name
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress                    = Email Address
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"># Optionally, specify some defaults.
</span></span></span><span class="line"><span class="cl"><span class="s">countryName_default             = ${CA_DN_DEFAULT_COUNTRY_CODE}
</span></span></span><span class="line"><span class="cl"><span class="s">stateOrProvinceName_default     = &#34;${CA_DN_DEFAULT_STATE_OR_PROVINCE}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">localityName_default            = &#34;${CA_DN_DEFAULT_LOCALITY}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">0.organizationName_default      = &#34;${CA_DN_DEFAULT_ORG}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">organizationalUnitName_default  = &#34;${CA_DN_DEFAULT_ORG_UNIT}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">commonName_default              = &#34;${INTERMEDIATE_NAME}.${CA_DN_DEFAULT_COMMON_NAME}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">emailAddress_default            = &#34;${CA_DN_DEFAULT_EMAIL_ADDRESS}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ v3_ca ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for a typical CA (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid:always,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = critical, CA:true
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature, cRLSign, keyCertSign
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ v3_intermediate_ca ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for a typical intermediate CA (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid:always,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = critical, CA:true, pathlen:0
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature, cRLSign, keyCertSign
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ usr_cert ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for client certificates (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">nsCertType = client, email
</span></span></span><span class="line"><span class="cl"><span class="s">nsComment = &#34;${NS_CLIENT_CERT_COMMENT}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = clientAuth, emailProtection
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ server_cert ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extensions for server certificates (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">nsCertType = server
</span></span></span><span class="line"><span class="cl"><span class="s">nsComment = &#34;${NS_SERVER_CERT_COMMENT}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid,issuer:always
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature, keyEncipherment
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = serverAuth
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ crl_ext ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extension for CRLs (&#39;man x509v3_config&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier=keyid:always
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[ ocsp ]
</span></span></span><span class="line"><span class="cl"><span class="s"># Extension for OCSP signing certificates (&#39;man ocsp&#39;).
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints = CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">subjectKeyIdentifier = hash
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier = keyid,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = critical, digitalSignature
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = critical, OCSPSigning
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generate intermediate CA certificate for ${CA_NAME}/${INTERMEDIATE_NAME} in ${INTERMEDIATEDIR}...&#34;</span>
</span></span><span class="line"><span class="cl">openssl genrsa -aes256 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -out <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/private/intermediate.key.pem <span class="m">4096</span>
</span></span><span class="line"><span class="cl">chmod <span class="m">400</span> <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/private/intermediate.key.pem
</span></span><span class="line"><span class="cl">openssl req -config <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/openssl.cnf -new -sha256 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -key <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/private/intermediate.key.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -out <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/csr/intermediate.csr.pem
</span></span><span class="line"><span class="cl">openssl ca -config <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/openssl.cnf -extensions v3_intermediate_ca <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -days <span class="si">${</span><span class="nv">DEFAULT_CA_DAYS</span><span class="si">}</span> -notext -md sha256 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -in <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/csr/intermediate.csr.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -out <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/certs/intermediate.cert.pem
</span></span><span class="line"><span class="cl">chmod <span class="m">444</span> <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/certs/intermediate.cert.pem
</span></span><span class="line"><span class="cl">openssl x509 -noout -text <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -in <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/certs/intermediate.cert.pem
</span></span><span class="line"><span class="cl">openssl verify -CAfile <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/certs/ca.cert.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/certs/intermediate.cert.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generate the chain:</span>
</span></span><span class="line"><span class="cl">cat <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/certs/intermediate.cert.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      <span class="si">${</span><span class="nv">CADIR</span><span class="si">}</span>/certs/ca.cert.pem &gt; <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/chain/ca-chain.cert.pem
</span></span><span class="line"><span class="cl">chmod <span class="m">444</span> <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/certs/ca-chain.cert.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># convert intermediate CA key to PKCS1 format required by Vault bundle</span>
</span></span><span class="line"><span class="cl">openssl rsa -in <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/private/intermediate.key.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -out <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/vault-bundle/intermediate-pkcs1.key.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -outform pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generate the actual Vault bundle:</span>
</span></span><span class="line"><span class="cl">cat <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/chain/ca-chain.cert.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/vault-bundle/intermediate-pkcs1.key.pem &gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/vault-bundle/bundle.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># remove the pkcs1 file:</span>
</span></span><span class="line"><span class="cl">rm <span class="si">${</span><span class="nv">INTERMEDIATEDIR</span><span class="si">}</span>/vault-bundle/intermediate-pkcs1.key.pem
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>After saving as <code>~/.ca/init-intermediate.sh</code>, making executable with <code>chmod +x ~/.ca/init-intermediate.sh</code>, it can be executed. I&rsquo;m going to create two intermediate CAs immediately. In my case, mirroring the imaginary use case for setting up Keycloak with multiple clients<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">[3]</a></sup>, I have:</p>
<ul>
<li>ClientA <code>~/.ca/init-intermediate.sh article-ca client-a</code></li>
<li>ClientB <code>~/.ca/init-intermediate.sh article-ca client-b</code></li>
</ul>
<p>In each case, the program will ask the following:</p>
<ul>
<li>the intermediate CA key password, three times: to create the key, verify the password and use the key</li>
<li>verify to confirm distinguished name defaults, additionally a common name</li>
<li>root CA key password during intermediate signing</li>
<li>a couple of confirmations</li>
<li>once again a passphrase of the intermediate CA key for pkcs1 conversion</li>
</ul>
<p>After these two commands are finished, the files on disk look similar to:</p>
<pre tabindex="0"><code>[rad] ~ $ tree ~/.ca/article-ca/
/Users/rad/.ca/article-ca/
âââ certs
âÂ Â  âââ ca.cert.pem
âââ crl
âââ index.txt
âââ index.txt.attr
âââ index.txt.attr.old
âââ index.txt.old
âââ intermediate
âÂ Â  âââ client-a
âÂ Â  âÂ Â  âââ certs
âÂ Â  âÂ Â  âÂ Â  âââ intermediate.cert.pem
âÂ Â  âÂ Â  âââ chain
âÂ Â  âÂ Â  âÂ Â  âââ ca-chain.cert.pem
âÂ Â  âÂ Â  âââ crl
âÂ Â  âÂ Â  âââ crlnumber
âÂ Â  âÂ Â  âââ csr
âÂ Â  âÂ Â  âÂ Â  âââ intermediate.csr.pem
âÂ Â  âÂ Â  âââ index.txt
âÂ Â  âÂ Â  âââ newcerts
âÂ Â  âÂ Â  âââ openssl.cnf
âÂ Â  âÂ Â  âââ private
âÂ Â  âÂ Â  âÂ Â  âââ intermediate.key.pem
âÂ Â  âÂ Â  âââ serial
âÂ Â  âÂ Â  âââ vault-bundle
âÂ Â  âÂ Â      âââ bundle.pem
âÂ Â  âââ client-b
âÂ Â      âââ certs
âÂ Â      âÂ Â  âââ intermediate.cert.pem
âÂ Â      âââ chain
âÂ Â      âÂ Â  âââ ca-chain.cert.pem
âÂ Â      âââ crl
âÂ Â      âââ crlnumber
âÂ Â      âââ csr
âÂ Â      âÂ Â  âââ intermediate.csr.pem
âÂ Â      âââ index.txt
âÂ Â      âââ newcerts
âÂ Â      âââ openssl.cnf
âÂ Â      âââ private
âÂ Â      âÂ Â  âââ intermediate.key.pem
âÂ Â      âââ serial
âÂ Â      âââ vault-bundle
âÂ Â          âââ bundle.pem
âââ newcerts
âÂ Â  âââ 1000.pem
âÂ Â  âââ 1001.pem
âââ openssl.cnf
âââ private
âÂ Â  âââ ca.key.pem
âââ serial
âââ serial.old

21 directories, 29 files
</code></pre><p>The output of the intermediate CA init, for one of the executions, is similar to:</p>
<pre tabindex="0"><code>Generating RSA private key, 4096 bit long modulus
...........................................++
.....................................................................................................................................................................................................................................................................................++
e is 65537 (0x10001)
Enter pass phrase for /Users/rad/.ca/article-ca/intermediate/client-a/private/intermediate.key.pem:
Verifying - Enter pass phrase for /Users/rad/.ca/article-ca/intermediate/client-a/private/intermediate.key.pem:
Enter pass phrase for /Users/rad/.ca/article-ca/intermediate/client-a/private/intermediate.key.pem:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [DE]:
State or Province Name [NRW]:
Locality Name [Herzogenrath]:
Organization Name [klarrio.com]:
Organizational Unit Name [gmbh]:
Common Name [client-a.gmbh.klarrio.com]:
Email Address [radek.gruchalski@klarrio.com]:
Using configuration from /Users/rad/.ca/article-ca/openssl.cnf
Enter pass phrase for /Users/rad/.ca/article-ca/private/ca.key.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 4096 (0x1000)
        Validity
            Not Before: Sep  8 21:05:08 2020 GMT
            Not After : Sep  8 21:05:08 2021 GMT
        Subject:
            countryName               = DE
            stateOrProvinceName       = NRW
            organizationName          = klarrio.com
            organizationalUnitName    = gmbh
            commonName                = client-a.gmbh.klarrio.com
            emailAddress              = radek.gruchalski@klarrio.com
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                47:7D:8A:9E:DC:23:03:7A:AA:E4:79:A8:98:EE:40:54:01:84:1C:E8
            X509v3 Authority Key Identifier:
                keyid:06:DE:59:CD:9A:21:9F:A0:B2:32:EE:B3:E6:89:11:10:9C:6E:83:0F

            X509v3 Basic Constraints: critical
                CA:TRUE, pathlen:0
            X509v3 Key Usage: critical
                Digital Signature, Certificate Sign, CRL Sign
Certificate is to be certified until Sep  8 21:05:08 2021 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 4096 (0x1000)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=DE, ST=NRW, L=Herzogenrath, O=klarrio.com, OU=gmbh/emailAddress=radek.gruchalski@klarrio.com
        Validity
            Not Before: Sep  9 21:05:08 2020 GMT
            Not After : Sep  9 21:05:08 2021 GMT
        Subject: C=DE, ST=NRW, O=klarrio.com, OU=gmbh, CN=client-a.gmbh.klarrio.com/emailAddress=radek.gruchalski@klarrio.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:aa:c3:eb:7e:c4:2a:79:2e:bc:7b:6f:c2:61:f9:
                    ...
                    80:27:da:c6:b8:ff:20:3b:7f:9b:fd:ff:15:d0:2c:
                    e7:2b:03
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                47:7D:8A:9E:DC:23:03:7A:AA:E4:79:A8:98:EE:40:54:01:84:1C:E8
            X509v3 Authority Key Identifier:
                keyid:06:DE:59:CD:9A:21:9F:A0:B2:32:EE:B3:E6:89:11:10:9C:6E:83:0F

            X509v3 Basic Constraints: critical
                CA:TRUE, pathlen:0
            X509v3 Key Usage: critical
                Digital Signature, Certificate Sign, CRL Sign
    Signature Algorithm: sha256WithRSAEncryption
         22:b5:e3:6e:a5:d6:0d:6b:30:65:a3:d9:68:27:38:2b:ea:64:
         ...
         39:ac:c3:66:88:8c:f0:eb
/Users/rad/.ca/article-ca/intermediate/client-a/certs/intermediate.cert.pem: OK
Enter pass phrase for /Users/rad/.ca/article-ca/intermediate/client-a/private/intermediate.key.pem:
writing RSA key
</code></pre><p>At this stage, I have a root CA and two intermediate CA for respective common names:</p>
<ul>
<li>ClientA: <code>client-a.gmbh.klarrio.com</code></li>
<li>ClientB: <code>client-b.gmbh.klarrio.com</code></li>
</ul>
<p>For every intermediate, I have a PEM bundle ready to be imported to HashiCorp Vault.</p>
<h2 id="start-vault-in-development-mode"><a href="#start-vault-in-development-mode" class="anchor-link">Â§</a>Start Vault in development mode</h2>
<p>I&rsquo;m going to use Vault development mode, with <code>VAULT_DEV_ROOT_TOKEN_ID</code> hard coded and default port <code>8200</code> exposed so it can be reached from <code>localhost</code>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run --rm <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -p 8200:8200 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -ti <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -e <span class="s1">&#39;VAULT_DEV_ROOT_TOKEN_ID=dev-token&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -e <span class="s1">&#39;VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --cap-add<span class="o">=</span>IPC_LOCK <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    vault
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">2020-09-08T21:08:07.855Z <span class="o">[</span>INFO<span class="o">]</span>  expiration: revoked lease: <span class="nv">lease_id</span><span class="o">=</span>auth/token/root/h128b471d9329710fbbd34dc5a4a98b4d0c7fe104799e818447a013762aed1e66
</span></span><span class="line"><span class="cl">2020-09-08T21:08:07.859Z <span class="o">[</span>INFO<span class="o">]</span>  core: successful mount: <span class="nv">namespace</span><span class="o">=</span> <span class="nv">path</span><span class="o">=</span>secret/ <span class="nv">type</span><span class="o">=</span>kv
</span></span><span class="line"><span class="cl">2020-09-08T21:08:07.869Z <span class="o">[</span>INFO<span class="o">]</span>  secrets.kv.kv_9795fd99: collecting keys to upgrade
</span></span><span class="line"><span class="cl">2020-09-08T21:08:07.869Z <span class="o">[</span>INFO<span class="o">]</span>  secrets.kv.kv_9795fd99: <span class="k">done</span> collecting keys: <span class="nv">num_keys</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">2020-09-08T21:08:07.869Z <span class="o">[</span>INFO<span class="o">]</span>  secrets.kv.kv_9795fd99: upgrading keys finished
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Now, in another terminal window, I am going to export the token and Vault address environment variables:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span>http://127.0.0.1:8200
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VAULT_TOKEN</span><span class="o">=</span>dev-token
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>Finally, I can enable PKIs:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vault secrets <span class="nb">enable</span> -path<span class="o">=</span>client-a pki
</span></span><span class="line"><span class="cl">vault secrets <span class="nb">enable</span> -path<span class="o">=</span>client-b pki
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>I can see Vault confirming:</p>
<pre tabindex="0"><code>2020-09-08T21:11:32.133Z [INFO]  core: successful mount: namespace= path=client-a/ type=pki
2020-09-08T21:11:32.914Z [INFO]  core: successful mount: namespace= path=client-b/ type=pki
</code></pre><h2 id="importing-the-bundles"><a href="#importing-the-bundles" class="anchor-link">Â§</a>Importing the bundles</h2>
<p>The next step is to import the PEM bundles, they were prepared during the intermediate CA creation:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ vault write client-a/config/ca <span class="nv">pem_bundle</span><span class="o">=</span>@<span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/article-ca/intermediate/client-a/vault-bundle/bundle.pem
</span></span><span class="line"><span class="cl">Success! Data written to: client-a/config/ca
</span></span><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ vault write client-b/config/ca <span class="nv">pem_bundle</span><span class="o">=</span>@<span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.ca/article-ca/intermediate/client-b/vault-bundle/bundle.pem
</span></span><span class="line"><span class="cl">Success! Data written to: client-b/config/ca
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ vault write client-a/roles/system-of-client-a-com <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_localhost</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_bare_domains</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allowed_domains</span><span class="o">=</span><span class="s2">&#34;localhost,client-a.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_subdomains</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">max_ttl</span><span class="o">=</span><span class="s2">&#34;720h&#34;</span>
</span></span><span class="line"><span class="cl">Success! Data written to: client-a/roles/system-of-client-a-com
</span></span><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ vault write client-b/roles/system-of-client-b-com <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_localhost</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_bare_domains</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allowed_domains</span><span class="o">=</span><span class="s2">&#34;localhost,client-b.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_subdomains</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">max_ttl</span><span class="o">=</span><span class="s2">&#34;720h&#34;</span>
</span></span><span class="line"><span class="cl">Success! Data written to: client-b/roles/system-of-client-b-com
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="notes-to-the-examples-above"><a href="#notes-to-the-examples-above" class="anchor-link">Â§</a>Notes to the examples above</h3>
<ol>
<li>By setting <code>allow_bare_domains</code> to <code>true</code>, I allow the user to generate a certificate for any literal domain specified in <code>allowed_domains</code>, so the user can issue a certificate for <code>client-[X].gmbh.klarrio.com</code>.</li>
<li>By setting <code>allow_localhost</code> to <code>true</code>, I allow issuing a certificate for <code>localhost</code>, useful for testing.</li>
<li>By setting <code>allow_subdomains</code> to <code>true</code>, I give the user the ability to issue certificates with common names that are subdomains of <code>allowed_domains</code>.</li>
</ol>
<p>All the interesting options are documented in the Vault documentation<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">[4]</a></sup>.</p>
<h2 id="requesting-certificates"><a href="#requesting-certificates" class="anchor-link">Â§</a>Requesting certificates</h2>
<p>To request a certificate, simply issue the following command:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vault write client-a/issue/system-of-client-a-com <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">common_name</span><span class="o">=</span><span class="s2">&#34;become.client-a.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">ttl</span><span class="o">=</span><span class="s2">&#34;240h&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">format</span><span class="o">=</span>pem
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>To which the output is &hellip; pretty verbose &hellip;:</p>
<pre tabindex="0"><code>Key                 Value
---                 -----
ca_chain            [-----BEGIN CERTIFICATE-----
MIIF+zCCA+OgAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwgYQxCzAJBgNVBAYTAkRF
MQwwCgYDVQQIDANOUlcxFTATBgNVBAcMDEhlcnpvZ2VucmF0aDEUMBIGA1UECgwL
...
KhlaTNBfyYaIYXeTQgCa+ar7OcZQhKMvPv1dTOFtZQ8Rjk5+8Y0yOazDZoiM8Os=
-----END CERTIFICATE----- -----BEGIN CERTIFICATE-----
MIIF8DCCA9igAwIBAgIJAMZZGbhgTk0HMA0GCSqGSIb3DQEBCwUAMIGEMQswCQYD
...
kY3o7PdJs57rbyjVo3UWLZwQbqBkMpH3zxjKLco8lE3UscEU7Up/ZxqQF9i3Wxj1
bahjbSfvI/V5gKaVkfcp/Pe1wavMFSI0GueEzP4oU7F2YyLN
-----END CERTIFICATE-----]
certificate         -----BEGIN CERTIFICATE-----
MIIE8TCCAtmgAwIBAgIUZWaMXolFNt/ufzgUOnvu79ZCVjEwDQYJKoZIhvcNAQEL
BQAwgZMxCzAJBgNVBAYTAkRFMQwwCgYDVQQIDANOUlcxFDASBgNVBAoMC2tsYXJy
...
nJOv5KyaSz8OCKdX+JlVmU9Qoapj4EyXOZQ+LS8RBsFXrbjpjqxdd3kpiEhpcQwN
7UXijzXX25gZKwFPTof+VdAKa5M1/uU9G15KwL4S/vJwYGwL/zo799qrGdd/+plV
cOd4GA883CW0DdC8QuU2+w3HIRS6
-----END CERTIFICATE-----
expiration          1600616181
issuing_ca          -----BEGIN CERTIFICATE-----
MIIF+zCCA+OgAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwgYQxCzAJBgNVBAYTAkRF
MQwwCgYDVQQIDANOUlcxFTATBgNVBAcMDEhlcnpvZ2VucmF0aDEUMBIGA1UECgwL
a2xhcnJpby5jb20xDTALBgNVBAsMBGdtYmgxKzApBgkqhkiG9w0BCQEWHHJhZGVr
...
pIjI/wXZwURNn920ODhsA0v467Llw4gMTTjxOfDIFrdZ46936IMzHNOXI5b87dfU
KhlaTNBfyYaIYXeTQgCa+ar7OcZQhKMvPv1dTOFtZQ8Rjk5+8Y0yOazDZoiM8Os=
-----END CERTIFICATE-----
private_key         -----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA57Ww9OC6UzHaLAALdbotEoTf5c2qw4BufVlOB7zZh+GbX2hR
...
zcDV96GoXPEnuXHdVsfePFIdPS7IRmAEn72UW6u39mVqGJuX1/5tk76ay6cPHP/B
xtX2UAplk9bD046wNh1/PxudBnqavOFf4F5uDizYhyihbmmhS/mcxA==
-----END RSA PRIVATE KEY-----
private_key_type    rsa
serial_number       65:66:8c:5e:89:45:36:df:ee:7f:38:14:3a:7b:ee:ef:d6:42:56:31
</code></pre><p>Cool, we have the certificate, a private key and a certificate chain. The CA chain can now be copied to <code>chain.pem</code> file.</p>
<p><img src="/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/ca-chain.png" alt="CA chain"></p>
<p><strong>Pay attention to the</strong> <code>-----END CERTIFICATE----- -----BEGIN CERTIFICATE-----</code> <strong>bit.</strong> It needs to be saved as:</p>
<pre tabindex="0"><code>...
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
...
</code></pre><p>Copy the certificate to <code>certificate.pem</code>:</p>
<p><img src="/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/certificate.png" alt="certificate"></p>
<p>And the private to <code>key.pem</code>:</p>
<p><img src="/assets/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/private-key.png" alt="private key"></p>
<p>A server with TLS transport can now be created using the <code>chain.pem</code>, <code>certificate.pem</code> and <code>key.pem</code> files.</p>
<h2 id="why-is-this-cool"><a href="#why-is-this-cool" class="anchor-link">Â§</a>Why is this cool</h2>
<ol>
<li>It&rsquo;s not possible to request certificates for domain names not in <code>allowed_domains</code>:</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ vault write client-a/issue/system-of-client-a-com <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">common_name</span><span class="o">=</span><span class="s2">&#34;become.client-b.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">ttl</span><span class="o">=</span><span class="s2">&#34;240h&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">format</span><span class="o">=</span>pem
</span></span><span class="line"><span class="cl">Error writing data to client-a/issue/system-of-client-a-com: Error making API request.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">URL: PUT http://127.0.0.1:8200/v1/client-a/issue/system-of-client-a-com
</span></span><span class="line"><span class="cl">Code: 400. Errors:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* common name become.client-b.gmbh.klarrio.com not allowed by this role
</span></span></code></pre></td></tr></table></div>
</div>
</div><ol start="2">
<li>It&rsquo;s possible to provide alt names:</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vault write client-b/issue/system-of-client-b-com <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">common_name</span><span class="o">=</span><span class="s2">&#34;get-in-touch.client-b.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">alt_names</span><span class="o">=</span><span class="s2">&#34;you.client-b.gmbh.klarrio.com,or-you.client-b.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">ttl</span><span class="o">=</span><span class="s2">&#34;720h&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">format</span><span class="o">=</span>pem
</span></span></code></pre></td></tr></table></div>
</div>
</div><ol start="3">
<li>Certificates generated for <code>ClientA</code> do not validate for <code>ClientB</code> and vice versa - different intermediate</li>
<li>It is very easy to define a policy with different criteria. For example: to allow a user of <code>ClientB</code> to generate a certificate for specific domain only:</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>rad<span class="o">]</span> ~ $ vault write client-a/roles/get-in-touch <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allow_bare_domains</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">allowed_domains</span><span class="o">=</span><span class="s2">&#34;get-in-touch.client-a.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">max_ttl</span><span class="o">=</span><span class="s2">&#34;1h&#34;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>so that it&rsquo;s possible to:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vault write client-a/issue/get-in-touch <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">common_name</span><span class="o">=</span><span class="s2">&#34;get-in-touch.client-a.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">ttl</span><span class="o">=</span><span class="s2">&#34;1h&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">format</span><span class="o">=</span>pem
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>but not:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vault write client-a/issue/get-in-touch <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">common_name</span><span class="o">=</span><span class="s2">&#34;maybe.get-in-touch.client-a.gmbh.klarrio.com&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">ttl</span><span class="o">=</span><span class="s2">&#34;1h&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">format</span><span class="o">=</span>pem
</span></span></code></pre></td></tr></table></div>
</div>
</div><h2 id="conclusion"><a href="#conclusion" class="anchor-link">Â§</a>Conclusion</h2>
<p>Once the initial setting up of the program to create the CAs is finished, the rest of the process is straightforward. Adding new clients (intermediates) is fairly easy. Configuring Vault is not a big job. Vault PKI is a solid choice for a multi-tenant PKI solution.</p>
<p>Of course, there are still some challenges left on the table. Mainly storing the root and intermediate certificates safely and properly ensuring who can access them.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="/posts/2020-09-07-certificate-authority-is-not-voodoo/">Certificate Authority is not Voodoo</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:2">
<p><a href="https://jamielinux.com/docs/openssl-certificate-authority/" target="_blank" rel="noopener">OpenSSL Certificate Authority</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:3">
<p><a href="/posts/2020-09-05-introduction-to-keycloak-authorization-services/">Introduction to Keycloak Authorization Services</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
<li id="fn:4">
<p><a href="https://www.vaultproject.io/api-docs/secret/pki#parameters-8" target="_blank" rel="noopener">Vault PKI Create/Update Role Parameters</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p>
</li>
</ol>
</div>

            </div>

            <div class="subscribe-container">

    <h2 class="subscribe">Never miss a post</h2>
    <p class="subscribe">Interested in similar content? Get it right into your mailbox. <strong>Sign up now.</strong></p>

    <div class="inner">
        <form action="https://gruchalski.us1.list-manage.com/subscribe/post?u=7cc31051b7ae9b4636244cbb2&amp;id=80eb233246"
            method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate>
            
            <div class="away" aria-hidden="true"><input type="text" name="b_7cc31051b7ae9b4636244cbb2_80eb233246" tabindex="-1" value=""></div>
            <div class="form-fields">
                <input type="email" value="" name="EMAIL" placeholder="email address" />
                <input type="submit" value="Subscribe" name="subscribe" />
            </div>
        </form>
    </div>

</div>
            
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">Author</span>: <a href="https://io-oi.me/" class="p-author h-card" target="_blank" rel="noopener">radek gruchalski</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">Link</span>: <a href="/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/" target="_blank" rel="noopener">https://gruchalski.com/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">License</span>: <a href="https://en.wikipedia.org/wiki/Canonical_link_element" target="_blank" rel="noopener">reposting requires attribution, <strong>use canonical links</strong> Â»</a></li>
            
        </ul>
    



        </article>

        

        


        


        <div class="post-share">

        

        <div class="share-items">

            
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=https://gruchalski.com/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/&amp;text=Multi-tenant%20Vault%20PKI%20with%20custom%20root%20PEM%20bundles&amp;hashtags=pki,ca,tls,openssl,vault,multi-tenant,&amp;via=%25!s%28%3cnil%3e%29" title="Share on Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            

            
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://gruchalski.com/posts/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle/&amp;title=Multi-tenant%20Vault%20PKI%20with%20custom%20root%20PEM%20bundles&amp;summary=Configuring%20multi-tenant%20Vault%20PKI%20with%20OpenSSL%20root%20and%20intermediate%20CAs&amp;source=gruchalski.com" title="Share on LinkedIn" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            

            

            

            

            

            
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="Share via QR Code"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/gruchalski.com\/posts\/2020-09-09-multi-tenant-vault-pki-with-custom-root-pem-bundle\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">See Also:<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/2020-09-07-certificate-authority-is-not-voodoo/" class="related-link">Certificate Authority is not Voodoo</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2021-03-28-firebuild-rootfs-grpc-with-mtls/" class="related-link">firebuild rootfs - gRPC with mTLS</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2020-09-05-introduction-to-keycloak-authorization-services/" class="related-link">Introduction to Keycloak Authorization Services</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2022-02-20-keycloak-1700-with-tls-behind-envoy/" class="related-link">Keycloak 17.0.0 with TLS in Docker compose behind Envoy proxy</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/2021-06-06-keycloak-with-tls-behind-envoy/" class="related-link">Keycloak with TLS in Docker compose behind Envoy proxy</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/pki/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>pki</a>
                
            
                
                
                
                
                    
                    <a href="/tags/ca/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>ca</a>
                
            
                
                
                
                
                    
                    <a href="/tags/tls/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>tls</a>
                
            
                
                
                
                
                    
                    <a href="/tags/openssl/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>openssl</a>
                
            
                
                
                
                
                    
                    <a href="/tags/vault/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>vault</a>
                
            
                
                
                
                
                    
                    <a href="/tags/multi-tenant/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>multi-tenant</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/posts/2020-09-09-authenticate-to-private-jfrog-npm-registry/" rel="prev">&lt; Authenticate to private JFrog npm registry</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/posts/2020-09-07-certificate-authority-is-not-voodoo/" rel="next">Certificate Authority is not Voodoo &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">Â©&nbsp;2015â2022&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;radek gruchalski</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://en.wikipedia.org/wiki/Canonical_link_element" target="_blank" rel="noopener">reposting requires attribution, <strong>use canonical links</strong> Â»</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:radek@gruchalski.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/radekg" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://linkedin.com/in/radgruchalski" target="_blank" rel="external noopener" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon social-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </li></ul>
    



            <p>this website uses Google Analytics but<br />
    it respects your DNT settings, stores tracking ID in session storage instead of cookies and anonymizes IP addresses </p>
        </div>
    </footer>


        </div>
        

        








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
